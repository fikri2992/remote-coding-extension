<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
    <!-- Essential meta tags for mobile-first optimization -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    
    <!-- Security and performance -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' ws: wss:; img-src 'self' data: https:; font-src 'self' data:; manifest-src 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- PWA and mobile optimization -->
    <meta name="theme-color" content="#1e1e1e" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VSCode Tunnel">
    <meta name="application-name" content="VSCode Tunnel">
    <meta name="msapplication-TileColor" content="#1e1e1e">
    <meta name="msapplication-config" content="./browserconfig.xml">
    
    <!-- SEO and accessibility -->
    <meta name="description" content="Mobile-first web automation interface for Visual Studio Code with enhanced accessibility and offline support">
    <meta name="keywords" content="vscode, automation, accessibility, mobile, progressive web app">
    <meta name="author" content="VS Code Web Automation Tunnel">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Open Graph for better sharing -->
    <meta property="og:title" content="VS Code Web Automation Tunnel">
    <meta property="og:description" content="Mobile-first web automation interface for Visual Studio Code">
    <meta property="og:type" content="website">
    <meta property="og:image" content="./assets/icons/icon-512.png">
    
    <!-- Title -->
    <title>VS Code Web Automation Tunnel</title>
    
    <!-- PWA manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Icons for different platforms -->
    <link rel="icon" type="image/svg+xml" href="./assets/icons/icon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/icons/icon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/icons/apple-touch-icon.png">
    <link rel="mask-icon" href="./assets/icons/safari-pinned-tab.svg" color="#007acc">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="./js/enhanced.js" as="script">
    <link rel="preload" href="./js/basic.js" as="script">
    <link rel="preconnect" href="ws://localhost" crossorigin>
    <link rel="preconnect" href="wss://localhost" crossorigin>
    
    <!-- DNS prefetch for potential external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    
    <!-- Critical CSS for immediate rendering (mobile-first) -->
    <style>
        /* CSS Reset and base mobile-first styles */
        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px; /* Base font size for mobile readability */
            scroll-behavior: smooth;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            font-size: 1rem;
            line-height: 1.5;
            background: var(--vscode-editor-background, #1e1e1e);
            color: var(--vscode-foreground, #cccccc);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--vscode-button-background, #0e639c);
            color: var(--vscode-button-foreground, #ffffff);
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 10001;
            font-size: 14px;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* Loading screen critical styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--vscode-editor-background, #1e1e1e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 2rem;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--vscode-progressBar-background, #454545);
            border-top: 3px solid var(--vscode-progressBar-foreground, #007acc);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--vscode-foreground, #cccccc);
            font-size: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .loading-progress {
            width: 100%;
            max-width: 300px;
            height: 4px;
            background: var(--vscode-progressBar-background, #454545);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--vscode-progressBar-foreground, #007acc);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Touch-optimized interactive elements */
        button, .interactive {
            min-height: 44px; /* WCAG touch target minimum */
            min-width: 44px;
            padding: 12px 16px;
            border: 1px solid var(--vscode-button-border, transparent);
            border-radius: 4px;
            background: var(--vscode-button-background, #0e639c);
            color: var(--vscode-button-foreground, #ffffff);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            outline: none;
        }
        
        button:hover, .interactive:hover {
            background: var(--vscode-button-hoverBackground, #1177bb);
        }
        
        button:focus, .interactive:focus {
            outline: 2px solid var(--vscode-focusBorder, #007acc);
            outline-offset: 2px;
        }
        
        button:active, .interactive:active {
            transform: translateY(1px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            button, .interactive {
                border: 2px solid;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            html {
                scroll-behavior: auto;
            }
        }
        
        /* Dark theme adjustments */
        .vscode-theme-dark {
            color-scheme: dark;
        }
        
        /* Light theme adjustments */
        .vscode-theme-light {
            color-scheme: light;
        }
        
        /* Mobile-first responsive utilities */
        @media (max-width: 767px) {
            .loading-screen {
                padding: 1rem;
            }
            
            .loading-text {
                font-size: 0.9rem;
            }
        }
    </style>
    
    <!-- Conditional Styles -->
    <link rel="stylesheet" href="styles/enhanced-main.css" id="mainStyles">
    <link rel="stylesheet" href="styles/basic.css" id="basicStyles">
    <link rel="stylesheet" href="styles/enhanced.css" id="enhancedStyles">
    <link rel="stylesheet" href="styles/components.css" id="componentsStyles">
    <link rel="stylesheet" href="styles/themes.css" id="themesStyles">
    <link rel="stylesheet" href="styles/animations.css" id="animationsStyles">
    <link rel="stylesheet" href="styles/touch.css" id="touchStyles">
</head>

<body class="vscode-theme-dark" role="application" aria-label="VS Code Web Automation Tunnel">
    <!-- Skip navigation for accessibility -->
    <a href="#main-content" class="skip-link" aria-label="Skip to main content">Skip to main content</a>
    
    <!-- Loading screen with accessibility support -->
    <div id="loadingScreen" class="loading-screen" role="status" aria-live="polite" aria-label="Application loading">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div class="loading-text" id="loadingText">Initializing VS Code Web Automation Tunnel...</div>
        <div class="loading-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Loading progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>
    
    <!-- Basic UI Container with semantic structure -->
    <div id="basicApp" class="ui-container basic-ui" style="display: none;" role="main" aria-label="Basic user interface">
        <div class="container">
            <!-- Main header with navigation -->
            <header role="banner" class="app-header">
                <div class="header-content">
                    <h1 class="app-title">VS Code Web Automation Tunnel</h1>
                    <nav role="navigation" aria-label="Connection status and settings">
                        <div class="connection-status" id="basicConnectionStatus" role="status" aria-live="polite">
                            <span class="status-indicator" id="basicStatusIndicator" aria-hidden="true"></span>
                            <span id="basicStatusText" aria-label="Connection status">Connecting...</span>
                        </div>
                    </nav>
                </div>
            </header>

            <!-- Main content area -->
            <main id="main-content" role="main" class="app-main" aria-label="Main application content">
                <!-- Server information section -->
                <section class="server-info" aria-labelledby="server-info-heading">
                    <h2 id="server-info-heading" class="section-heading">Server Information</h2>
                    <div class="info-grid" role="group" aria-label="Server status information">
                        <div class="info-item" role="group">
                            <label for="basicServerUrl" class="info-label">Server URL:</label>
                            <span id="basicServerUrl" class="info-value" aria-live="polite">-</span>
                        </div>
                        <div class="info-item" role="group">
                            <label for="basicWebsocketPort" class="info-label">WebSocket Port:</label>
                            <span id="basicWebsocketPort" class="info-value" aria-live="polite">-</span>
                        </div>
                        <div class="info-item" role="group">
                            <label for="basicConnectedClients" class="info-label">Connected Clients:</label>
                            <span id="basicConnectedClients" class="info-value" aria-live="polite">-</span>
                        </div>
                        <div class="info-item" role="group">
                            <label for="basicUptime" class="info-label">Uptime:</label>
                            <span id="basicUptime" class="info-value" aria-live="polite">-</span>
                        </div>
                    </div>
                </section>

                <!-- Command interface section -->
                <section class="command-interface" aria-labelledby="command-interface-heading">
                    <h2 id="command-interface-heading" class="section-heading">Command Interface</h2>
                    
                    <!-- Quick commands subsection -->
                    <div class="quick-commands" aria-labelledby="quick-commands-heading">
                        <h3 id="quick-commands-heading" class="subsection-heading">Quick Commands</h3>
                        <div class="command-buttons" role="group" aria-label="Quick command buttons">
                            <button class="quick-cmd-btn" data-command="workbench.action.files.newUntitledFile" 
                                    aria-label="Create new untitled file" type="button">
                                <span class="btn-icon" aria-hidden="true">📄</span>
                                <span class="btn-text">New File</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.files.save" 
                                    aria-label="Save current file" type="button">
                                <span class="btn-icon" aria-hidden="true">💾</span>
                                <span class="btn-text">Save File</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.showCommands" 
                                    aria-label="Open command palette" type="button">
                                <span class="btn-icon" aria-hidden="true">⌘</span>
                                <span class="btn-text">Command Palette</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.quickOpen" 
                                    aria-label="Open quick file picker" type="button">
                                <span class="btn-icon" aria-hidden="true">🔍</span>
                                <span class="btn-text">Quick Open</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.toggleSidebarVisibility" 
                                    aria-label="Toggle sidebar visibility" type="button">
                                <span class="btn-icon" aria-hidden="true">📋</span>
                                <span class="btn-text">Toggle Sidebar</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.terminal.toggleTerminal" 
                                    aria-label="Toggle terminal panel" type="button">
                                <span class="btn-icon" aria-hidden="true">💻</span>
                                <span class="btn-text">Toggle Terminal</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="editor.action.formatDocument" 
                                    aria-label="Format current document" type="button">
                                <span class="btn-icon" aria-hidden="true">✨</span>
                                <span class="btn-text">Format Document</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.reloadWindow" 
                                    aria-label="Reload VS Code window" type="button">
                                <span class="btn-icon" aria-hidden="true">🔄</span>
                                <span class="btn-text">Reload Window</span>
                            </button>
                        </div>
                    </div>

                    <!-- Custom command form -->
                    <div class="command-form" aria-labelledby="custom-command-heading">
                        <h3 id="custom-command-heading" class="subsection-heading">Custom Command</h3>
                        <form role="form" aria-label="Custom VS Code command execution">
                            <div class="input-group">
                                <label for="basicCommandInput" class="input-label">VS Code Command:</label>
                                <input type="text" id="basicCommandInput" class="command-input" 
                                       placeholder="e.g., workbench.action.files.newUntitledFile"
                                       aria-describedby="command-help" autocomplete="off" spellcheck="false">
                                <div id="command-help" class="input-help">Enter a VS Code command identifier</div>
                            </div>
                            <div class="input-group">
                                <label for="basicArgsInput" class="input-label">Arguments (JSON):</label>
                                <textarea id="basicArgsInput" class="args-input" rows="3"
                                          placeholder='["arg1", "arg2"] or leave empty'
                                          aria-describedby="args-help" spellcheck="false"></textarea>
                                <div id="args-help" class="input-help">Optional JSON array of command arguments</div>
                            </div>
                            <button id="basicExecuteButton" type="button" class="execute-btn" disabled 
                                    aria-label="Execute the custom command">
                                <span class="btn-icon" aria-hidden="true">▶️</span>
                                <span class="btn-text">Execute Command</span>
                            </button>
                        </form>
                    </div>
                </section>

                <!-- Workspace state section -->
                <section class="workspace-state" aria-labelledby="workspace-state-heading">
                    <h2 id="workspace-state-heading" class="section-heading">VS Code State</h2>
                    <div class="state-display" role="group" aria-label="Current VS Code workspace state">
                        <div class="state-section" aria-labelledby="active-editor-heading">
                            <h3 id="active-editor-heading" class="subsection-heading">Active Editor</h3>
                            <div id="basicActiveEditor" class="state-value" role="status" aria-live="polite" 
                                 aria-label="Currently active editor">No active editor</div>
                        </div>
                        <div class="state-section" aria-labelledby="workspace-folders-heading">
                            <h3 id="workspace-folders-heading" class="subsection-heading">Workspace Folders</h3>
                            <div id="basicWorkspaceFolders" class="state-value" role="status" aria-live="polite"
                                 aria-label="Open workspace folders">No workspace folders</div>
                        </div>
                        <div class="state-section" aria-labelledby="open-editors-heading">
                            <h3 id="open-editors-heading" class="subsection-heading">Open Editors</h3>
                            <div id="basicOpenEditors" class="state-value" role="status" aria-live="polite"
                                 aria-label="List of open editors">No open editors</div>
                        </div>
                    </div>
                </section>

                <!-- Message log section -->
                <section class="message-log" aria-labelledby="message-log-heading">
                    <h2 id="message-log-heading" class="section-heading">Message Log</h2>
                    <div class="log-controls" role="toolbar" aria-label="Log controls">
                        <button id="basicClearLogButton" type="button" class="clear-log-btn" 
                                aria-label="Clear all log messages">
                            <span class="btn-icon" aria-hidden="true">🗑️</span>
                            <span class="btn-text">Clear Log</span>
                        </button>
                    </div>
                    <div class="log-container" id="basicMessageLog" role="log" aria-live="polite" 
                         aria-label="Application message log" tabindex="0"></div>
                </section>
            </main>
        </div>
    </div>

    <!-- Enhanced UI Container with semantic structure -->
    <div id="enhancedApp" class="ui-container enhanced-ui app-container" style="display: none;" 
         role="main" aria-label="Enhanced user interface">
        <!-- App Shell will be rendered here by enhanced UI components -->
        <div id="app" class="app-shell" role="application" aria-label="Enhanced VS Code automation interface">
            <!-- Enhanced UI components will be dynamically loaded here -->
        </div>
    </div>

    <!-- UI Mode Toggle (for development/debugging) -->
    <div class="ui-toggle" id="uiToggle" role="complementary" aria-label="Development tools"
         style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">
        <button id="toggleUIButton" type="button" class="toggle-btn" 
                aria-label="Toggle between basic and enhanced UI modes" title="Toggle UI Mode">
            <span aria-hidden="true">🔄</span>
            <span class="sr-only">Toggle UI</span>
        </button>
    </div>
    
    <!-- Accessibility and no-JavaScript fallback -->
    <noscript>
        <div class="no-js-fallback" role="alert" aria-live="assertive">
            <div class="fallback-container">
                <header class="fallback-header">
                    <h1>JavaScript Required</h1>
                    <p class="fallback-subtitle">VS Code Web Automation Tunnel</p>
                </header>
                
                <main class="fallback-content">
                    <section class="fallback-message">
                        <h2>Enable JavaScript to Continue</h2>
                        <p>This application requires JavaScript to provide the full VS Code automation experience. 
                           Please enable JavaScript in your browser settings and refresh the page.</p>
                    </section>
                    
                    <section class="fallback-instructions">
                        <h3>How to Enable JavaScript:</h3>
                        <details>
                            <summary>Chrome/Edge</summary>
                            <ol>
                                <li>Click the three dots menu → Settings</li>
                                <li>Go to Privacy and security → Site Settings</li>
                                <li>Click JavaScript → Allow sites to use JavaScript</li>
                                <li>Refresh this page</li>
                            </ol>
                        </details>
                        <details>
                            <summary>Firefox</summary>
                            <ol>
                                <li>Type "about:config" in the address bar</li>
                                <li>Search for "javascript.enabled"</li>
                                <li>Set the value to "true"</li>
                                <li>Refresh this page</li>
                            </ol>
                        </details>
                        <details>
                            <summary>Safari</summary>
                            <ol>
                                <li>Safari menu → Preferences → Security</li>
                                <li>Check "Enable JavaScript"</li>
                                <li>Refresh this page</li>
                            </ol>
                        </details>
                    </section>
                    
                    <section class="fallback-alternative">
                        <h3>Alternative Access</h3>
                        <p>If you cannot enable JavaScript, you can still access VS Code directly:</p>
                        <ul>
                            <li>Open VS Code desktop application</li>
                            <li>Use VS Code in your browser at <a href="https://vscode.dev" target="_blank" rel="noopener">vscode.dev</a></li>
                            <li>Install the VS Code extension locally</li>
                        </ul>
                    </section>
                </main>
                
                <footer class="fallback-footer">
                    <p>For technical support, please refer to the VS Code documentation or contact your system administrator.</p>
                </footer>
            </div>
        </div>
        
        <style>
            .no-js-fallback {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #1e1e1e;
                color: #cccccc;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 1rem;
                box-sizing: border-box;
            }
            
            .fallback-container {
                max-width: 600px;
                text-align: center;
                line-height: 1.6;
            }
            
            .fallback-header h1 {
                color: #f14c4c;
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }
            
            .fallback-subtitle {
                color: #9d9d9d;
                font-size: 1.1rem;
                margin-bottom: 2rem;
            }
            
            .fallback-content {
                text-align: left;
            }
            
            .fallback-message {
                background: #2d2d30;
                padding: 1.5rem;
                border-radius: 8px;
                margin-bottom: 2rem;
                border-left: 4px solid #007acc;
            }
            
            .fallback-instructions details {
                margin: 1rem 0;
                background: #2d2d30;
                padding: 1rem;
                border-radius: 4px;
            }
            
            .fallback-instructions summary {
                cursor: pointer;
                font-weight: bold;
                color: #007acc;
                margin-bottom: 0.5rem;
            }
            
            .fallback-instructions ol {
                margin: 0.5rem 0 0 1rem;
            }
            
            .fallback-alternative {
                background: #2d2d30;
                padding: 1.5rem;
                border-radius: 8px;
                margin: 2rem 0;
            }
            
            .fallback-alternative a {
                color: #007acc;
                text-decoration: none;
            }
            
            .fallback-alternative a:hover {
                text-decoration: underline;
            }
            
            .fallback-footer {
                margin-top: 2rem;
                padding-top: 1rem;
                border-top: 1px solid #454545;
                color: #9d9d9d;
                font-size: 0.9rem;
            }
            
            @media (max-width: 768px) {
                .fallback-container {
                    padding: 1rem;
                }
                
                .fallback-header h1 {
                    font-size: 1.5rem;
                }
            }
        </style>
    </noscript>

    <!-- Adaptive JavaScript Loader -->
    <script>
        // Global configuration
        window.webAutomationConfig = {
            isVSCodeWebview: typeof acquireVsCodeApi !== 'undefined',
            vscode: null,
            useEnhancedUI: true, // Will be set dynamically
            debugMode: false
        };

        // Initialize VS Code API if available
        if (window.webAutomationConfig.isVSCodeWebview) {
            try {
                window.webAutomationConfig.vscode = acquireVsCodeApi();
                window.vscode = window.webAutomationConfig.vscode;
            } catch (error) {
                console.warn('Failed to acquire VS Code API:', error);
            }
        }

        // UI Mode Detection and Loading
        async function initializeUI() {
            try {
                // Detect UI mode from URL parameters or configuration
                const urlParams = new URLSearchParams(window.location.search);
                const uiMode = urlParams.get('ui') || 'enhanced';
                const debugMode = urlParams.has('debug');
                
                window.webAutomationConfig.useEnhancedUI = uiMode === 'enhanced';
                window.webAutomationConfig.debugMode = debugMode;

                // Show debug toggle in debug mode
                if (debugMode) {
                    document.getElementById('uiToggle').style.display = 'block';
                }

                // Load appropriate UI
                if (window.webAutomationConfig.useEnhancedUI) {
                    await loadEnhancedUI();
                } else {
                    await loadBasicUI();
                }

            } catch (error) {
                console.error('Failed to initialize UI:', error);
                // Fallback to basic UI
                await loadBasicUI();
            }
        }

        // Load Enhanced UI
        async function loadEnhancedUI() {
            console.log('Step 1/6: Loading Enhanced UI...');
            
            // Show enhanced container
            document.getElementById('enhancedApp').style.display = 'block';
            document.getElementById('basicApp').style.display = 'none';
            
            // Load enhanced styles only
            document.getElementById('basicStyles').disabled = true;
            document.getElementById('enhancedStyles').disabled = false;
            document.getElementById('componentsStyles').disabled = false;
            document.getElementById('themesStyles').disabled = false;
            document.getElementById('animationsStyles').disabled = false;
            document.getElementById('touchStyles').disabled = false;

            console.log('Step 2/6: Enhanced styles loaded');

            // Set up enhanced UI container elements
            const enhancedContainer = document.getElementById('enhancedApp');
            
            // Create app element if it doesn't exist (enhanced UI expects 'app' id)
            let appElement = document.getElementById('app');
            if (!appElement) {
                appElement = document.createElement('div');
                appElement.id = 'app';
                appElement.className = 'app-container';
                enhancedContainer.appendChild(appElement);
            }
            
            // Update loading screen reference (enhanced UI expects 'loadingScreen' id)
            const enhancedLoadingScreen = document.getElementById('enhancedLoadingScreen');
            if (enhancedLoadingScreen && !document.getElementById('loadingScreen')) {
                enhancedLoadingScreen.id = 'loadingScreen';
            }

            console.log('Step 3/6: Enhanced UI container prepared');

            // Implement 30-second timeout mechanism
            const initializationTimeout = setTimeout(() => {
                console.error('❌ Enhanced UI initialization timeout (30 seconds)');
                showTimeoutError();
            }, 30000);

            // Load enhanced JavaScript modules with graceful degradation
            try {
                console.log('Step 4/6: Loading Enhanced JavaScript modules...');
                
                // Use traditional script loading instead of dynamic imports
                await loadScript('./js/enhanced.js');
                
                console.log('Step 5/6: Enhanced modules loaded, initializing app...');
                
                // Check if EnhancedApp class is available
                if (typeof window.EnhancedApp !== 'undefined') {
                    window.enhancedApp = new window.EnhancedApp();
                    await window.enhancedApp.initialize();
                    
                    console.log('Step 6/6: Enhanced UI initialization complete ✅');
                    clearTimeout(initializationTimeout);
                } else {
                    throw new Error('EnhancedApp class not found after loading script');
                }
                
            } catch (error) {
                clearTimeout(initializationTimeout);
                console.error('❌ Failed to load enhanced UI:', error);
                
                // Graceful degradation - fallback to basic UI
                console.log('🔄 Falling back to Basic UI due to Enhanced UI failure');
                await loadBasicUI();
            }
        }

        // Load Basic UI
        async function loadBasicUI() {
            console.log('Step 1/4: Loading Basic UI...');
            
            // Show basic container
            document.getElementById('basicApp').style.display = 'block';
            document.getElementById('enhancedApp').style.display = 'none';
            
            // Load basic styles only
            document.getElementById('basicStyles').disabled = false;
            document.getElementById('enhancedStyles').disabled = true;
            document.getElementById('componentsStyles').disabled = true;
            document.getElementById('themesStyles').disabled = true;
            document.getElementById('animationsStyles').disabled = true;
            document.getElementById('touchStyles').disabled = true;

            console.log('Step 2/4: Basic styles loaded');

            // Update element IDs for basic UI (it expects elements without 'basic' prefix)
            updateBasicUIElementIds();

            console.log('Step 3/4: Basic UI elements prepared');

            // Implement 30-second timeout mechanism
            const initializationTimeout = setTimeout(() => {
                console.error('❌ Basic UI initialization timeout (30 seconds)');
                showTimeoutError();
            }, 30000);

            // Load basic JavaScript
            try {
                // Use traditional script loading instead of dynamic imports
                await loadScript('./js/basic.js');
                
                // Check if BasicApp class is available
                if (typeof window.BasicApp !== 'undefined') {
                    window.basicApp = new window.BasicApp();
                    await window.basicApp.initialize();
                    
                    console.log('Step 4/4: Basic UI initialization complete ✅');
                    clearTimeout(initializationTimeout);
                } else {
                    throw new Error('BasicApp class not found after loading script');
                }
                
            } catch (error) {
                clearTimeout(initializationTimeout);
                console.error('❌ Failed to load basic UI:', error);
                
                // Show final error screen
                showFinalErrorScreen(error);
            }
        }

        // Toggle UI Mode (for debugging)
        function toggleUI() {
            window.webAutomationConfig.useEnhancedUI = !window.webAutomationConfig.useEnhancedUI;
            location.reload();
        }

        // Update Basic UI element IDs (remove 'basic' prefix for compatibility)
        function updateBasicUIElementIds() {
            const elementMapping = {
                'basicConnectionStatus': 'connectionStatus',
                'basicStatusIndicator': 'statusIndicator', 
                'basicStatusText': 'statusText',
                'basicServerUrl': 'serverUrl',
                'basicWebsocketPort': 'websocketPort',
                'basicConnectedClients': 'connectedClients',
                'basicUptime': 'uptime',
                'basicCommandInput': 'commandInput',
                'basicArgsInput': 'argsInput',
                'basicExecuteButton': 'executeButton',
                'basicActiveEditor': 'activeEditor',
                'basicWorkspaceFolders': 'workspaceFolders',
                'basicOpenEditors': 'openEditors',
                'basicMessageLog': 'messageLog',
                'basicClearLogButton': 'clearLogButton'
            };

            for (const [basicId, targetId] of Object.entries(elementMapping)) {
                const element = document.getElementById(basicId);
                if (element && !document.getElementById(targetId)) {
                    element.id = targetId;
                }
            }
        }

        // Show timeout error screen
        function showTimeoutError() {
            const errorScreen = createErrorScreen(
                'Initialization Timeout',
                'The UI failed to load within 30 seconds. This may be due to missing dependencies or network issues.',
                [
                    { text: 'Retry', action: () => location.reload() },
                    { text: 'Try Basic UI', action: () => { window.location.search = '?ui=basic'; location.reload(); } },
                    { text: 'Debug Mode', action: () => { window.location.search = '?debug&ui=' + (window.webAutomationConfig.useEnhancedUI ? 'enhanced' : 'basic'); location.reload(); } }
                ]
            );
            document.body.appendChild(errorScreen);
        }

        // Show final error screen when both UIs fail
        function showFinalErrorScreen(error) {
            const errorScreen = createErrorScreen(
                'Critical UI Failure',
                'Both Enhanced and Basic UIs failed to load. Please check the browser console for details.',
                [
                    { text: 'Reload Page', action: () => location.reload() },
                    { text: 'Report Issue', action: () => window.open('https://github.com/microsoft/vscode/issues/new', '_blank') }
                ],
                error
            );
            document.body.appendChild(errorScreen);
        }

        // Load script using traditional method (compatible with VS Code webviews)
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if script is already loaded
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.type = 'text/javascript';
                
                script.onload = () => {
                    console.log(`✅ Script loaded: ${src}`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    console.error(`❌ Failed to load script: ${src}`, error);
                    reject(new Error(`Failed to load script: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // Create standardized error screen
        function createErrorScreen(title, message, actions = [], error = null) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'error-screen';
            
            let errorDetails = '';
            if (error) {
                errorDetails = `
                    <details style="margin: 1rem 0; text-align: left;">
                        <summary>Technical Details</summary>
                        <pre style="background: var(--vscode-textCodeBlock-background, #2d2d30); padding: 1rem; border-radius: 4px; overflow: auto; max-height: 200px; font-size: 12px; white-space: pre-wrap;">${error.message}\n${error.stack || ''}</pre>
                    </details>
                `;
            }
            
            const actionButtons = actions.map(action => 
                `<button onclick="(${action.action.toString()})()" style="background: var(--vscode-button-background, #0e639c); color: var(--vscode-button-foreground, #ffffff); border: none; padding: 8px 16px; margin: 0 8px; border-radius: 2px; cursor: pointer; font-size: 14px;">${action.text}</button>`
            ).join('');
            
            errorContainer.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--vscode-editor-background, #1e1e1e); color: var(--vscode-foreground, #cccccc); display: flex; align-items: center; justify-content: center; z-index: 10000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="max-width: 600px; padding: 2rem; text-align: center;">
                        <h1 style="color: var(--vscode-errorForeground, #f14c4c); font-size: 24px; margin-bottom: 16px;">⚠️ ${title}</h1>
                        <p style="font-size: 16px; line-height: 1.5; margin-bottom: 24px;">${message}</p>
                        ${errorDetails}
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap;">
                            ${actionButtons}
                        </div>
                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--vscode-widget-border, #454545); color: var(--vscode-descriptionForeground, #9d9d9d); font-size: 12px;">
                            <p>VS Code Web Automation Tunnel</p>
                            <p>If this problem persists, please check the browser console (F12) for additional information.</p>
                        </div>
                    </div>
                </div>
            `;
            
            return errorContainer;
        }

        // Remove no-js class when JavaScript is available
        document.documentElement.classList.remove('no-js');
        document.documentElement.classList.add('js');
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', initializeUI);
        document.getElementById('toggleUIButton').addEventListener('click', toggleUI);

        // Enhanced message handling for VS Code webview
        if (window.webAutomationConfig.isVSCodeWebview) {
            window.addEventListener('message', event => {
                const message = event.data;
                
                // Forward messages to active UI
                if (window.webAutomationConfig.useEnhancedUI && window.enhancedApp) {
                    window.enhancedApp.handleMessage?.(message);
                } else if (window.basicApp) {
                    window.basicApp.handleMessage?.(message);
                }
            });
        }
    </script>
</body>
</html>