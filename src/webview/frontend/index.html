<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' ws: wss:; img-src 'self' data: https:;">
    <title>VS Code Web Automation Tunnel</title>
    
    <!-- Conditional Styles -->
    <link rel="stylesheet" href="styles/enhanced-main.css" id="mainStyles">
    <link rel="stylesheet" href="styles/basic.css" id="basicStyles">
    <link rel="stylesheet" href="styles/enhanced.css" id="enhancedStyles">
    <link rel="stylesheet" href="styles/components.css" id="componentsStyles">
    <link rel="stylesheet" href="styles/themes.css" id="themesStyles">
    <link rel="stylesheet" href="styles/animations.css" id="animationsStyles">
    <link rel="stylesheet" href="styles/touch.css" id="touchStyles">
</head>

<body class="vscode-theme-dark">
    <!-- Basic UI Container -->
    <div id="basicApp" class="ui-container basic-ui" style="display: none;">
        <div class="container">
            <header>
                <h1>VS Code Web Automation Tunnel</h1>
                <div class="connection-status" id="basicConnectionStatus">
                    <span class="status-indicator" id="basicStatusIndicator"></span>
                    <span id="basicStatusText">Connecting...</span>
                </div>
            </header>

            <main>
                <section class="server-info">
                    <h2>Server Information</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Server URL:</label>
                            <span id="basicServerUrl">-</span>
                        </div>
                        <div class="info-item">
                            <label>WebSocket Port:</label>
                            <span id="basicWebsocketPort">-</span>
                        </div>
                        <div class="info-item">
                            <label>Connected Clients:</label>
                            <span id="basicConnectedClients">-</span>
                        </div>
                        <div class="info-item">
                            <label>Uptime:</label>
                            <span id="basicUptime">-</span>
                        </div>
                    </div>
                </section>

                <section class="command-interface">
                    <h2>Command Interface</h2>
                    
                    <div class="quick-commands">
                        <h3>Quick Commands</h3>
                        <div class="command-buttons">
                            <button class="quick-cmd-btn" data-command="workbench.action.files.newUntitledFile">New File</button>
                            <button class="quick-cmd-btn" data-command="workbench.action.files.save">Save File</button>
                            <button class="quick-cmd-btn" data-command="workbench.action.showCommands">Command Palette</button>
                            <button class="quick-cmd-btn" data-command="workbench.action.quickOpen">Quick Open</button>
                            <button class="quick-cmd-btn" data-command="workbench.action.toggleSidebarVisibility">Toggle Sidebar</button>
                            <button class="quick-cmd-btn" data-command="workbench.action.terminal.toggleTerminal">Toggle Terminal</button>
                            <button class="quick-cmd-btn" data-command="editor.action.formatDocument">Format Document</button>
                            <button class="quick-cmd-btn" data-command="workbench.action.reloadWindow">Reload Window</button>
                        </div>
                    </div>

                    <div class="command-form">
                        <h3>Custom Command</h3>
                        <div class="input-group">
                            <label for="basicCommandInput">VS Code Command:</label>
                            <input type="text" id="basicCommandInput" placeholder="e.g., workbench.action.files.newUntitledFile">
                        </div>
                        <div class="input-group">
                            <label for="basicArgsInput">Arguments (JSON):</label>
                            <textarea id="basicArgsInput" placeholder='["arg1", "arg2"] or leave empty'></textarea>
                        </div>
                        <button id="basicExecuteButton" disabled>Execute Command</button>
                    </div>
                </section>

                <section class="workspace-state">
                    <h2>VS Code State</h2>
                    <div class="state-display">
                        <div class="state-section">
                            <h3>Active Editor</h3>
                            <div id="basicActiveEditor">No active editor</div>
                        </div>
                        <div class="state-section">
                            <h3>Workspace Folders</h3>
                            <div id="basicWorkspaceFolders">No workspace folders</div>
                        </div>
                        <div class="state-section">
                            <h3>Open Editors</h3>
                            <div id="basicOpenEditors">No open editors</div>
                        </div>
                    </div>
                </section>

                <section class="message-log">
                    <h2>Message Log</h2>
                    <div class="log-controls">
                        <button id="basicClearLogButton">Clear Log</button>
                    </div>
                    <div class="log-container" id="basicMessageLog"></div>
                </section>
            </main>
        </div>
    </div>

    <!-- Enhanced UI Container -->
    <div id="enhancedApp" class="ui-container enhanced-ui app-container" style="display: none;">
        <!-- App Shell will be rendered here -->
        <div class="loading-screen" id="enhancedLoadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">Initializing Enhanced UI...</div>
        </div>
    </div>

    <!-- UI Mode Toggle (for development/debugging) -->
    <div class="ui-toggle" id="uiToggle" style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">
        <button id="toggleUIButton" title="Toggle UI Mode">🔄</button>
    </div>

    <!-- Adaptive JavaScript Loader -->
    <script>
        // Global configuration
        window.webAutomationConfig = {
            isVSCodeWebview: typeof acquireVsCodeApi !== 'undefined',
            vscode: null,
            useEnhancedUI: true, // Will be set dynamically
            debugMode: false
        };

        // Initialize VS Code API if available
        if (window.webAutomationConfig.isVSCodeWebview) {
            try {
                window.webAutomationConfig.vscode = acquireVsCodeApi();
                window.vscode = window.webAutomationConfig.vscode;
            } catch (error) {
                console.warn('Failed to acquire VS Code API:', error);
            }
        }

        // UI Mode Detection and Loading
        async function initializeUI() {
            try {
                // Detect UI mode from URL parameters or configuration
                const urlParams = new URLSearchParams(window.location.search);
                const uiMode = urlParams.get('ui') || 'enhanced';
                const debugMode = urlParams.has('debug');
                
                window.webAutomationConfig.useEnhancedUI = uiMode === 'enhanced';
                window.webAutomationConfig.debugMode = debugMode;

                // Show debug toggle in debug mode
                if (debugMode) {
                    document.getElementById('uiToggle').style.display = 'block';
                }

                // Load appropriate UI
                if (window.webAutomationConfig.useEnhancedUI) {
                    await loadEnhancedUI();
                } else {
                    await loadBasicUI();
                }

            } catch (error) {
                console.error('Failed to initialize UI:', error);
                // Fallback to basic UI
                await loadBasicUI();
            }
        }

        // Load Enhanced UI
        async function loadEnhancedUI() {
            console.log('Step 1/6: Loading Enhanced UI...');
            
            // Show enhanced container
            document.getElementById('enhancedApp').style.display = 'block';
            document.getElementById('basicApp').style.display = 'none';
            
            // Load enhanced styles only
            document.getElementById('basicStyles').disabled = true;
            document.getElementById('enhancedStyles').disabled = false;
            document.getElementById('componentsStyles').disabled = false;
            document.getElementById('themesStyles').disabled = false;
            document.getElementById('animationsStyles').disabled = false;
            document.getElementById('touchStyles').disabled = false;

            console.log('Step 2/6: Enhanced styles loaded');

            // Set up enhanced UI container elements
            const enhancedContainer = document.getElementById('enhancedApp');
            
            // Create app element if it doesn't exist (enhanced UI expects 'app' id)
            let appElement = document.getElementById('app');
            if (!appElement) {
                appElement = document.createElement('div');
                appElement.id = 'app';
                appElement.className = 'app-container';
                enhancedContainer.appendChild(appElement);
            }
            
            // Update loading screen reference (enhanced UI expects 'loadingScreen' id)
            const enhancedLoadingScreen = document.getElementById('enhancedLoadingScreen');
            if (enhancedLoadingScreen && !document.getElementById('loadingScreen')) {
                enhancedLoadingScreen.id = 'loadingScreen';
            }

            console.log('Step 3/6: Enhanced UI container prepared');

            // Implement 30-second timeout mechanism
            const initializationTimeout = setTimeout(() => {
                console.error('❌ Enhanced UI initialization timeout (30 seconds)');
                showTimeoutError();
            }, 30000);

            // Load enhanced JavaScript modules with graceful degradation
            try {
                console.log('Step 4/6: Loading Enhanced JavaScript modules...');
                
                // Use traditional script loading instead of dynamic imports
                await loadScript('./js/enhanced.js');
                
                console.log('Step 5/6: Enhanced modules loaded, initializing app...');
                
                // Check if EnhancedApp class is available
                if (typeof window.EnhancedApp !== 'undefined') {
                    window.enhancedApp = new window.EnhancedApp();
                    await window.enhancedApp.initialize();
                    
                    console.log('Step 6/6: Enhanced UI initialization complete ✅');
                    clearTimeout(initializationTimeout);
                } else {
                    throw new Error('EnhancedApp class not found after loading script');
                }
                
            } catch (error) {
                clearTimeout(initializationTimeout);
                console.error('❌ Failed to load enhanced UI:', error);
                
                // Graceful degradation - fallback to basic UI
                console.log('🔄 Falling back to Basic UI due to Enhanced UI failure');
                await loadBasicUI();
            }
        }

        // Load Basic UI
        async function loadBasicUI() {
            console.log('Step 1/4: Loading Basic UI...');
            
            // Show basic container
            document.getElementById('basicApp').style.display = 'block';
            document.getElementById('enhancedApp').style.display = 'none';
            
            // Load basic styles only
            document.getElementById('basicStyles').disabled = false;
            document.getElementById('enhancedStyles').disabled = true;
            document.getElementById('componentsStyles').disabled = true;
            document.getElementById('themesStyles').disabled = true;
            document.getElementById('animationsStyles').disabled = true;
            document.getElementById('touchStyles').disabled = true;

            console.log('Step 2/4: Basic styles loaded');

            // Update element IDs for basic UI (it expects elements without 'basic' prefix)
            updateBasicUIElementIds();

            console.log('Step 3/4: Basic UI elements prepared');

            // Implement 30-second timeout mechanism
            const initializationTimeout = setTimeout(() => {
                console.error('❌ Basic UI initialization timeout (30 seconds)');
                showTimeoutError();
            }, 30000);

            // Load basic JavaScript
            try {
                // Use traditional script loading instead of dynamic imports
                await loadScript('./js/basic.js');
                
                // Check if BasicApp class is available
                if (typeof window.BasicApp !== 'undefined') {
                    window.basicApp = new window.BasicApp();
                    await window.basicApp.initialize();
                    
                    console.log('Step 4/4: Basic UI initialization complete ✅');
                    clearTimeout(initializationTimeout);
                } else {
                    throw new Error('BasicApp class not found after loading script');
                }
                
            } catch (error) {
                clearTimeout(initializationTimeout);
                console.error('❌ Failed to load basic UI:', error);
                
                // Show final error screen
                showFinalErrorScreen(error);
            }
        }

        // Toggle UI Mode (for debugging)
        function toggleUI() {
            window.webAutomationConfig.useEnhancedUI = !window.webAutomationConfig.useEnhancedUI;
            location.reload();
        }

        // Update Basic UI element IDs (remove 'basic' prefix for compatibility)
        function updateBasicUIElementIds() {
            const elementMapping = {
                'basicConnectionStatus': 'connectionStatus',
                'basicStatusIndicator': 'statusIndicator', 
                'basicStatusText': 'statusText',
                'basicServerUrl': 'serverUrl',
                'basicWebsocketPort': 'websocketPort',
                'basicConnectedClients': 'connectedClients',
                'basicUptime': 'uptime',
                'basicCommandInput': 'commandInput',
                'basicArgsInput': 'argsInput',
                'basicExecuteButton': 'executeButton',
                'basicActiveEditor': 'activeEditor',
                'basicWorkspaceFolders': 'workspaceFolders',
                'basicOpenEditors': 'openEditors',
                'basicMessageLog': 'messageLog',
                'basicClearLogButton': 'clearLogButton'
            };

            for (const [basicId, targetId] of Object.entries(elementMapping)) {
                const element = document.getElementById(basicId);
                if (element && !document.getElementById(targetId)) {
                    element.id = targetId;
                }
            }
        }

        // Show timeout error screen
        function showTimeoutError() {
            const errorScreen = createErrorScreen(
                'Initialization Timeout',
                'The UI failed to load within 30 seconds. This may be due to missing dependencies or network issues.',
                [
                    { text: 'Retry', action: () => location.reload() },
                    { text: 'Try Basic UI', action: () => { window.location.search = '?ui=basic'; location.reload(); } },
                    { text: 'Debug Mode', action: () => { window.location.search = '?debug&ui=' + (window.webAutomationConfig.useEnhancedUI ? 'enhanced' : 'basic'); location.reload(); } }
                ]
            );
            document.body.appendChild(errorScreen);
        }

        // Show final error screen when both UIs fail
        function showFinalErrorScreen(error) {
            const errorScreen = createErrorScreen(
                'Critical UI Failure',
                'Both Enhanced and Basic UIs failed to load. Please check the browser console for details.',
                [
                    { text: 'Reload Page', action: () => location.reload() },
                    { text: 'Report Issue', action: () => window.open('https://github.com/microsoft/vscode/issues/new', '_blank') }
                ],
                error
            );
            document.body.appendChild(errorScreen);
        }

        // Load script using traditional method (compatible with VS Code webviews)
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if script is already loaded
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.type = 'text/javascript';
                
                script.onload = () => {
                    console.log(`✅ Script loaded: ${src}`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    console.error(`❌ Failed to load script: ${src}`, error);
                    reject(new Error(`Failed to load script: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // Create standardized error screen
        function createErrorScreen(title, message, actions = [], error = null) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'error-screen';
            
            let errorDetails = '';
            if (error) {
                errorDetails = `
                    <details style="margin: 1rem 0; text-align: left;">
                        <summary>Technical Details</summary>
                        <pre style="background: var(--vscode-textCodeBlock-background, #2d2d30); padding: 1rem; border-radius: 4px; overflow: auto; max-height: 200px; font-size: 12px; white-space: pre-wrap;">${error.message}\n${error.stack || ''}</pre>
                    </details>
                `;
            }
            
            const actionButtons = actions.map(action => 
                `<button onclick="(${action.action.toString()})()" style="background: var(--vscode-button-background, #0e639c); color: var(--vscode-button-foreground, #ffffff); border: none; padding: 8px 16px; margin: 0 8px; border-radius: 2px; cursor: pointer; font-size: 14px;">${action.text}</button>`
            ).join('');
            
            errorContainer.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--vscode-editor-background, #1e1e1e); color: var(--vscode-foreground, #cccccc); display: flex; align-items: center; justify-content: center; z-index: 10000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="max-width: 600px; padding: 2rem; text-align: center;">
                        <h1 style="color: var(--vscode-errorForeground, #f14c4c); font-size: 24px; margin-bottom: 16px;">⚠️ ${title}</h1>
                        <p style="font-size: 16px; line-height: 1.5; margin-bottom: 24px;">${message}</p>
                        ${errorDetails}
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap;">
                            ${actionButtons}
                        </div>
                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--vscode-widget-border, #454545); color: var(--vscode-descriptionForeground, #9d9d9d); font-size: 12px;">
                            <p>VS Code Web Automation Tunnel</p>
                            <p>If this problem persists, please check the browser console (F12) for additional information.</p>
                        </div>
                    </div>
                </div>
            `;
            
            return errorContainer;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', initializeUI);
        document.getElementById('toggleUIButton').addEventListener('click', toggleUI);

        // Enhanced message handling for VS Code webview
        if (window.webAutomationConfig.isVSCodeWebview) {
            window.addEventListener('message', event => {
                const message = event.data;
                
                // Forward messages to active UI
                if (window.webAutomationConfig.useEnhancedUI && window.enhancedApp) {
                    window.enhancedApp.handleMessage?.(message);
                } else if (window.basicApp) {
                    window.basicApp.handleMessage?.(message);
                }
            });
        }
    </script>
</body>
</html>