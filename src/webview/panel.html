<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline'; connect-src ws: wss:;">
    <title>Web Automation Tunnel</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            font-weight: var(--vscode-font-weight);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 16px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            padding: 16px;
            background-color: var(--vscode-panel-background);
        }
        .title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--vscode-foreground);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            color: var(--vscode-foreground);
        }
        .description {
            font-size: 13px;
            color: var(--vscode-descriptionForeground);
            margin: 0 0 16px 0;
            line-height: 1.4;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.running {
            background-color: var(--vscode-testing-iconPassed);
        }

        .status-dot.stopped {
            background-color: var(--vscode-testing-iconFailed);
        }

        .status-dot.loading {
            background-color: var(--vscode-testing-iconQueued);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-dot.error {
            background-color: var(--vscode-errorForeground);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 13px;
            font-weight: 500;
        }

        .server-info {
            background-color: var(--vscode-textCodeBlock-background);
            border: 1px solid var(--vscode-textBlockQuote-border);
            border-radius: 3px;
            padding: 12px;
            margin: 12px 0;
            font-family: var(--vscode-editor-font-family);
            font-size: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: var(--vscode-descriptionForeground);
            font-weight: 500;
        }

        .info-value {
            color: var(--vscode-foreground);
            font-family: monospace;
        }
        .action-button {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: 1px solid var(--vscode-button-border, transparent);
            border-radius: 2px;
            padding: 8px 16px;
            font-size: 13px;
            font-family: var(--vscode-font-family);
            cursor: pointer;
            outline: none;
            transition: background-color 0.1s ease;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-button:hover:not(:disabled) {
            background-color: var(--vscode-button-hoverBackground);
        }

        .action-button:active:not(:disabled) {
            background-color: var(--vscode-button-background);
            transform: translateY(1px);
        }

        .action-button:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: 2px;
        }

        .action-button:disabled {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .secondary-button {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .secondary-button:hover:not(:disabled) {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }

        .error-message {
            background-color: var(--vscode-inputValidation-errorBackground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            color: var(--vscode-errorForeground);
            padding: 8px 12px;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 8px;
        }

        .clients-list {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 3px;
            background-color: var(--vscode-editor-background);
        }

        .client-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--vscode-panel-border);
            font-size: 12px;
        }

        .client-item:last-child {
            border-bottom: none;
        }

        .client-id {
            font-family: monospace;
            color: var(--vscode-textLink-foreground);
        }

        .client-time {
            color: var(--vscode-descriptionForeground);
            font-size: 11px;
        }

        .hidden {
            display: none;
        }

        /* Tab styles */
        .tab-container {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            background-color: var(--vscode-panel-background);
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 16px;
            font-size: 13px;
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.1s ease;
        }

        .tab-button:hover {
            background-color: var(--vscode-toolbar-hoverBackground);
        }

        .tab-button.active {
            color: var(--vscode-textLink-foreground);
            border-bottom-color: var(--vscode-textLink-foreground);
        }

        .tab-content {
            display: none;
            padding: 16px;
        }

        .tab-content.active {
            display: block;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--vscode-foreground);
            margin-bottom: 4px;
        }

        .form-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-font-family);
            font-size: 13px;
        }

        .form-input:focus {
            outline: 1px solid var(--vscode-focusBorder);
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .form-description {
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
            margin-top: 4px;
        }

        .success-message {
            background-color: var(--vscode-notificationsInfoIcon-foreground, #3794ff);
            border: 1px solid var(--vscode-notificationsInfoIcon-foreground, #3794ff);
            color: var(--vscode-button-foreground);
            padding: 8px 12px;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 8px;
        }

        .form-checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .section {
                padding: 12px;
            }

            .button-group {
                flex-direction: column;
                gap: 8px;
            }

            .action-button {
                width: 100%;
                justify-content: center;
            }

            .tab-buttons {
                flex-wrap: wrap;
            }

            .tab-button {
                flex: 1;
                min-width: 120px;
                padding: 10px 12px;
                font-size: 12px;
            }

            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .server-info {
                padding: 10px;
            }

            .clients-list {
                max-height: 100px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .title {
                font-size: 14px;
            }

            .section-title {
                font-size: 13px;
            }

            .description {
                font-size: 12px;
            }

            .section {
                padding: 8px;
            }

            .status-text {
                font-size: 12px;
            }

            .action-button {
                padding: 6px 12px;
                font-size: 12px;
                min-height: 32px;
            }

            .tab-button {
                padding: 8px 10px;
                font-size: 11px;
                min-width: 100px;
            }

            .form-input {
                font-size: 12px;
                padding: 5px 6px;
            }

            .form-description {
                font-size: 11px;
            }

            .server-info {
                padding: 8px;
                font-size: 11px;
            }

            .client-item {
                padding: 6px 10px;
                font-size: 11px;
            }

            .client-time {
                font-size: 10px;
            }

            .error-message {
                padding: 6px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h3 class="title">Web Automation Tunnel</h3>
        <p class="description">Control and monitor the web automation server for remote VS Code access.</p>
        
        <!-- Tab Container -->
        <div class="tab-container">
            <!-- Tab Buttons -->
            <div class="tab-buttons" role="tablist" aria-label="Web Automation Tabs">
                <button id="tab-main" class="tab-button active" role="tab" aria-selected="true" aria-controls="main-tab" data-tab="main">Main</button>
                <button id="tab-settings" class="tab-button" role="tab" aria-selected="false" aria-controls="settings-tab" data-tab="settings">Settings</button>
            </div>
            
            <!-- Tab Content: Server -->
            <div id="main-tab" class="tab-content active" role="tabpanel" aria-labelledby="tab-main">
            <div class="section-title">Server Control</div>
            
            <div class="status-indicator">
                <div id="statusDot" class="status-dot stopped"></div>
                <span id="statusText" class="status-text">Server Stopped</span>
            </div>

            <div class="button-group">
                <button id="startServerBtn" class="action-button">
                    <span>▶</span> Start Server
                </button>
                <button id="stopServerBtn" class="action-button secondary-button" disabled>
                    <span>⏹</span> Stop Server
                </button>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>

        <!-- Server Information Section -->
        <div id="serverInfoSection" class="section hidden">
            <div class="section-title">Server Information</div>
            
            <div class="server-info">
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span id="serverStatus" class="info-value">Stopped</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Web Interface:</span>
                    <span id="webInterfaceUrl" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Public URL:</span>
                    <span id="publicUrl" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">HTTP Port:</span>
                    <span id="httpPort" class="info-value">-</span>
                </div>
                <!-- WebSocket Port removed in simplified model -->
                <div class="info-row">
                    <span class="info-label">Uptime:</span>
                    <span id="uptime" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Connected Clients:</span>
                    <span id="clientCount" class="info-value">0</span>
                </div>
            </div>
        </div>

        <!-- Connected Clients Section -->
        <div id="clientsSection" class="section hidden">
            <div class="section-title">Connected Clients</div>
            <div id="clientsList" class="clients-list">
                <div class="client-item">No clients connected</div>
            </div>
        </div>

        <!-- Web Interface Section -->
        <div class="section">
            <div class="section-title">Web Interface</div>
            <p class="description">Access the server in your browser.</p>
            <div class="button-group">
                <button id="openWebInterfaceBtn" class="action-button">
                    <span>🌐</span> Open Web Interface
                </button>
            </div>
        </div>

        <!-- Cloudflare Tunnel Section -->
        <div class="section" id="cloudflareSection">
            <div class="section-title">Cloudflare Tunnel</div>
            <p class="description">Expose your local server securely. Quick Tunnel requires no account. Named Tunnel uses your Cloudflare account.</p>
            <div class="server-info" aria-live="polite">
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span id="tunnelStatus" class="info-value">Inactive</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Public URL:</span>
                    <span id="tunnelUrl" class="info-value">-</span>
                </div>
            </div>
            <div class="button-group" style="margin-top:8px;">
                <button id="startQuickTunnelBtn" class="action-button"><span>⚡</span> Start Quick Tunnel</button>
                <button id="startNamedTunnelBtn" class="action-button secondary-button"><span>🔐</span> Start Named Tunnel</button>
                <button id="stopTunnelBtn" class="action-button secondary-button" disabled><span>⏹</span> Stop Tunnel</button>
                <button id="installCloudflaredBtn" class="action-button secondary-button"><span>⬇</span> Install cloudflared</button>
            </div>
            <div class="button-group" style="margin-top:8px;">
                <button id="copyTunnelUrlBtn" class="action-button" disabled>Copy URL</button>
            </div>
            <div id="tunnelError" class="error-message hidden" style="margin-top:8px;"></div>
        </div>

            <!-- Close Main Tab Content -->
            </div>
            
            <!-- Tab Content: Settings -->
            <div id="settings-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-settings">
                <div class="section-title">Server Settings</div>
                <p class="description">Only HTTP port is configurable. Other settings have been removed.</p>
                
                <form id="settingsForm">
                    <div class="form-group">
                        <label class="form-label" for="httpPortInput">HTTP Port</label>
                        <input type="number" id="httpPortInput" class="form-input" min="1024" max="65535" placeholder="3900">
                        <div class="form-description">Port for the HTTP server (1024-65535). Default: 3900.</div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="submit" class="action-button">Save Settings</button>
                        <button type="button" id="resetSettingsBtn" class="action-button secondary-button">Reset to Defaults</button>
                    </div>
                </form>
                
                <div id="settingsMessage" class="error-message hidden" style="margin-top: 16px;"></div>
            </div>
        </div>
        <script>
        // Get reference to VSCode API
        const vscode = (window.vscode || acquireVsCodeApi());
        
        // Tab management
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Get UI elements
        const startServerBtn = document.getElementById('startServerBtn');
        const stopServerBtn = document.getElementById('stopServerBtn');
        const openWebInterfaceBtn = document.getElementById('openWebInterfaceBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const errorMessage = document.getElementById('errorMessage');
        const serverInfoSection = document.getElementById('serverInfoSection');
        const clientsSection = document.getElementById('clientsSection');
        
        // Server info elements
        const serverStatus = document.getElementById('serverStatus');
        const webInterfaceUrl = document.getElementById('webInterfaceUrl');
        const publicUrl = document.getElementById('publicUrl');
        const httpPort = document.getElementById('httpPort');
        // websocketPort removed
        const uptime = document.getElementById('uptime');
        const clientCount = document.getElementById('clientCount');
        const clientsList = document.getElementById('clientsList');
        
        // Settings elements
        const settingsForm = document.getElementById('settingsForm');
        const httpPortInput = document.getElementById('httpPortInput');
        const resetSettingsBtn = document.getElementById('resetSettingsBtn');
        const settingsMessage = document.getElementById('settingsMessage');

        // Cloudflare elements
        const startQuickTunnelBtn = document.getElementById('startQuickTunnelBtn');
        const startNamedTunnelBtn = document.getElementById('startNamedTunnelBtn');
        const stopTunnelBtn = document.getElementById('stopTunnelBtn');
        const installCloudflaredBtn = document.getElementById('installCloudflaredBtn');
        const copyTunnelUrlBtn = document.getElementById('copyTunnelUrlBtn');
        const tunnelStatus = document.getElementById('tunnelStatus');
        const tunnelUrl = document.getElementById('tunnelUrl');
        const tunnelError = document.getElementById('tunnelError');

        // Current server state
        let currentServerState = {
            isRunning: false,
            isLoading: false
        };

        // Tab switching functionality
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // Keyboard navigation for tabs
        tabButtons.forEach(button => {
            button.addEventListener('keydown', onTabKeydown);
        });

        function switchTab(tabName) {
            // Remove active class/selection from all buttons and contents
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to selected button and content
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            const activeContent = document.getElementById(`${tabName}-tab`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.setAttribute('aria-selected', 'true');
            }
            if (activeContent) {
                activeContent.classList.add('active');
            }

            // Update tabindex for accessibility: only active tab is tabbable
            tabButtons.forEach(btn => {
                btn.setAttribute('tabindex', btn === activeBtn ? '0' : '-1');
            });
        }

        function onTabKeydown(e) {
            const keys = ['ArrowLeft', 'ArrowRight', 'Home', 'End'];
            if (!keys.includes(e.key)) return;
            e.preventDefault();

            const buttons = Array.from(tabButtons);
            const currentIndex = buttons.indexOf(document.activeElement);
            let newIndex = currentIndex;
            if (e.key === 'ArrowRight') newIndex = (currentIndex + 1) % buttons.length;
            if (e.key === 'ArrowLeft') newIndex = (currentIndex - 1 + buttons.length) % buttons.length;
            if (e.key === 'Home') newIndex = 0;
            if (e.key === 'End') newIndex = buttons.length - 1;

            const newTabName = buttons[newIndex].getAttribute('data-tab');
            switchTab(newTabName);
            buttons[newIndex].focus();
        }

        // Initialize tabs accessibility state for the default active tab
        const initialActive = document.querySelector('.tab-button.active');
        const initialTab = initialActive?.getAttribute('data-tab') || 'main';
        switchTab(initialTab);

        // Settings form handling
        settingsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveSettings();
        });

        resetSettingsBtn.addEventListener('click', function() {
            resetSettings();
        });

        function saveSettings() {
            const settings = {
                'webAutomationTunnel.httpPort': parseInt(httpPortInput.value) || 3900
            };
            vscode.postMessage({ command: 'updateConfiguration', data: settings });
        }

        function resetSettings() {
            vscode.postMessage({
                command: 'resetConfiguration'
            });
        }

        // Load current configuration
        function loadConfiguration(config) {
            if (config) {
                httpPortInput.value = config.httpPort || 3900;
            }
        }

        // Show settings message
        function showSettingsMessage(message, isError = false) {
            settingsMessage.textContent = message;
            settingsMessage.className = isError ? 'error-message' : 'success-message';
            settingsMessage.classList.remove('hidden');
            setTimeout(() => {
                settingsMessage.classList.add('hidden');
            }, 3000);
        }

        // Add click handlers for server control buttons
        startServerBtn.addEventListener('click', function() {
            if (currentServerState.isLoading) return;
            
            setLoadingState(true, 'Starting server...');
            vscode.postMessage({
                command: 'startServer'
            });
        });

        stopServerBtn.addEventListener('click', function() {
            if (currentServerState.isLoading) return;
            
            setLoadingState(true, 'Stopping server...');
            vscode.postMessage({
                command: 'stopServer'
            });
        });

        // Open web interface button
        openWebInterfaceBtn.addEventListener('click', function() {
            vscode.postMessage({
                command: 'openWebInterface'
            });
        });

        // Cloudflare buttons
        startQuickTunnelBtn.addEventListener('click', function() {
            vscode.postMessage({ command: 'startTunnel', data: {} });
        });
        startNamedTunnelBtn.addEventListener('click', function() {
            // Let the extension prompt for name/token
            vscode.postMessage({ command: 'startTunnel', data: { mode: 'named' } });
        });
        stopTunnelBtn.addEventListener('click', function() {
            vscode.postMessage({ command: 'stopTunnel' });
        });
        installCloudflaredBtn.addEventListener('click', function() {
            vscode.postMessage({ command: 'installCloudflared' });
        });
        copyTunnelUrlBtn.addEventListener('click', function() {
            if (tunnelUrl.textContent && tunnelUrl.textContent !== '-') {
                vscode.postMessage({ command: 'copyToClipboard', data: { text: tunnelUrl.textContent } });
            }
        });
        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'serverStatusUpdate':
                    updateServerStatus(message.data.status, message.data.clients);
                    break;
                case 'statusUpdate':
                    handleStatusUpdate(message.data);
                    break;
                case 'configurationUpdate':
                    // message.data contains { config, schema }
                    loadConfiguration(message.data?.config);
                    break;
                case 'tunnelStatusUpdate':
                    // { publicUrl, isRunning, error }
                    if (message.data?.error) {
                        tunnelError.textContent = message.data.error;
                        tunnelError.classList.remove('hidden');
                    } else {
                        tunnelError.classList.add('hidden');
                    }
                    if (message.data?.isRunning && message.data?.publicUrl) {
                        tunnelStatus.textContent = 'Active';
                        tunnelUrl.textContent = message.data.publicUrl;
                        copyTunnelUrlBtn.disabled = false;
                        stopTunnelBtn.disabled = false;
                    } else {
                        tunnelStatus.textContent = 'Inactive';
                        tunnelUrl.textContent = '-';
                        copyTunnelUrlBtn.disabled = true;
                        stopTunnelBtn.disabled = true;
                    }
                    break;
                case 'configurationUpdated':
                    showSettingsMessage('Settings saved successfully!');
                    break;
                case 'configurationResetSuccess':
                    showSettingsMessage('Settings reset to defaults!');
                    break;
                case 'configurationError':
                    showSettingsMessage(message.data.error, true);
                    break;
                default:
                    console.log('Unknown message from extension:', message);
                    break;
            }
        });

        // Update server status display
        function updateServerStatus(status, clients) {
            currentServerState.isRunning = status.isRunning;
            currentServerState.isLoading = false;

            // Update status indicator
            statusDot.className = 'status-dot ' + (status.isRunning ? 'running' : 'stopped');
            statusText.textContent = status.isRunning ? 'Server Running' : 'Server Stopped';

            // Update button states
            startServerBtn.disabled = status.isRunning;
            stopServerBtn.disabled = !status.isRunning;
            startServerBtn.innerHTML = '<span>▶</span> Start Server';
            stopServerBtn.innerHTML = '<span>⏹</span> Stop Server';

            // Update server information
            if (status.isRunning) {
                serverInfoSection.classList.remove('hidden');
                serverStatus.textContent = 'Running';
                webInterfaceUrl.textContent = status.webInterfaceUrl || `http://localhost:${status.httpPort || 3900}`;
                publicUrl.textContent = status.publicUrl || '-';
                httpPort.textContent = status.httpPort || '-';
                uptime.textContent = formatUptime(status.uptime);
                clientCount.textContent = status.connectedClients || 0;

                // Tunnel UI
                if (status.publicUrl) {
                    tunnelStatus.textContent = 'Active';
                    tunnelUrl.textContent = status.publicUrl;
                    copyTunnelUrlBtn.disabled = false;
                    stopTunnelBtn.disabled = false;
                } else {
                    tunnelStatus.textContent = 'Inactive';
                    tunnelUrl.textContent = '-';
                    copyTunnelUrlBtn.disabled = true;
                    stopTunnelBtn.disabled = true;
                }

                // Show clients section if there are connected clients
                if (status.connectedClients > 0) {
                    clientsSection.classList.remove('hidden');
                    updateClientsList(clients);
                } else {
                    clientsSection.classList.add('hidden');
                }
            } else {
                serverInfoSection.classList.add('hidden');
                clientsSection.classList.add('hidden');
            }

            // Handle errors
            if (status.lastError) {
                showError(status.lastError);
            } else {
                hideError();
            }
        }

        // Handle status updates (loading states, errors)
        function handleStatusUpdate(update) {
            switch (update.type) {
                case 'serverStarting':
                    setLoadingState(true, 'Starting server...');
                    break;
                case 'serverStopping':
                    setLoadingState(true, 'Stopping server...');
                    break;
                case 'serverError':
                    setLoadingState(false);
                    showError(update.error);
                    break;
            }
        }

        // Set loading state for buttons
        function setLoadingState(isLoading, message = '') {
            currentServerState.isLoading = isLoading;
            
            if (isLoading) {
                statusDot.className = 'status-dot loading';
                statusText.textContent = message;
                startServerBtn.disabled = true;
                stopServerBtn.disabled = true;
                startServerBtn.innerHTML = '<span>⏳</span> ' + message;
            }
        }

        // Update clients list
        function updateClientsList(clients) {
            if (!clients || clients.length === 0) {
                clientsList.innerHTML = '<div class="client-item">No clients connected</div>';
                return;
            }

            const clientsHtml = clients.map(client => `
                <div class="client-item">
                    <div class="client-id">${client.id}</div>
                    <div class="client-time">Connected: ${formatTime(client.connectedAt)}</div>
                </div>
            `).join('');

            clientsList.innerHTML = clientsHtml;
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Hide error message
        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // Format uptime in human readable format
        function formatUptime(milliseconds) {
            if (!milliseconds) return '-';
            
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Format time for display
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString();
        }

        // Handle keyboard events for accessibility
        [startServerBtn, stopServerBtn, executeButton, openWebInterfaceBtn].forEach(button => {
            button.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    button.click();
                }
            });
        });

        // Request initial server status
        vscode.postMessage({
            command: 'getServerStatus'
        });
        
        // Request initial configuration
        vscode.postMessage({
            command: 'getConfiguration'
        });
        
        // Log that webview is ready
        console.log('Web Automation Tunnel webview loaded and ready');
        </script>
</body>
</html>