<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
    <!-- Essential meta tags for mobile-first optimization -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    
    <!-- Security and performance -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' ws: wss:; img-src 'self' data: https:; font-src 'self' data:; manifest-src 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- PWA and mobile optimization -->
    <meta name="theme-color" content="#1e1e1e" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VSCode Tunnel">
    <meta name="application-name" content="VSCode Tunnel">
    <meta name="msapplication-TileColor" content="#1e1e1e">
    <meta name="msapplication-config" content="./browserconfig.xml">
    
    <!-- SEO and accessibility -->
    <meta name="description" content="Mobile-first web automation interface for Visual Studio Code with enhanced accessibility and offline support">
    <meta name="keywords" content="vscode, automation, accessibility, mobile, progressive web app">
    <meta name="author" content="VS Code Web Automation Tunnel">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Open Graph for better sharing -->
    <meta property="og:title" content="VS Code Web Automation Tunnel">
    <meta property="og:description" content="Mobile-first web automation interface for Visual Studio Code">
    <meta property="og:type" content="website">
    <meta property="og:image" content="./assets/icons/icon-512.png">
    
    <!-- Title -->
    <title>VS Code Web Automation Tunnel</title>
    
    <!-- PWA manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Icons for different platforms -->
    <link rel="icon" type="image/svg+xml" href="./assets/icons/icon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/icons/icon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/icons/apple-touch-icon.png">
    <link rel="mask-icon" href="./assets/icons/safari-pinned-tab.svg" color="#007acc">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="./js/enhanced.js" as="script">
    <link rel="preload" href="./js/basic.js" as="script">
    <link rel="preconnect" href="ws://localhost" crossorigin>
    <link rel="preconnect" href="wss://localhost" crossorigin>
    
    <!-- DNS prefetch for potential external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    
    <!-- Critical CSS for immediate rendering (mobile-first) -->
    <style>
        /* CSS Custom Properties for theming and consistency */
        :root {
            /* Color system */
            --primary-color: #007acc;
            --primary-hover: #1177bb;
            --primary-active: #005a9e;
            --secondary-color: #454545;
            --background-primary: #1e1e1e;
            --background-secondary: #2d2d30;
            --background-tertiary: #3e3e42;
            --text-primary: #cccccc;
            --text-secondary: #9d9d9d;
            --text-muted: #6a6a6a;
            --border-color: #454545;
            --focus-color: #007acc;
            --error-color: #f14c4c;
            --warning-color: #ffcc02;
            --success-color: #89d185;
            
            /* Spacing system (mobile-first) */
            --space-xs: 0.25rem;   /* 4px */
            --space-sm: 0.5rem;    /* 8px */
            --space-md: 1rem;      /* 16px */
            --space-lg: 1.5rem;    /* 24px */
            --space-xl: 2rem;      /* 32px */
            --space-2xl: 3rem;     /* 48px */
            
            /* Touch targets and sizing */
            --touch-target-min: 44px;
            --touch-target-comfortable: 48px;
            --border-radius-sm: 2px;
            --border-radius-md: 4px;
            --border-radius-lg: 8px;
            
            /* Typography scale (mobile-optimized) */
            --font-size-xs: 0.75rem;   /* 12px */
            --font-size-sm: 0.875rem;  /* 14px */
            --font-size-base: 1rem;    /* 16px */
            --font-size-lg: 1.125rem;  /* 18px */
            --font-size-xl: 1.25rem;   /* 20px */
            --font-size-2xl: 1.5rem;   /* 24px */
            --font-size-3xl: 2rem;     /* 32px */
            
            /* Line heights */
            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;
            
            /* Animation and transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.2s ease;
            --transition-slow: 0.3s ease;
            
            /* Z-index scale */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
            --z-toast: 1080;
            
            /* Container sizes */
            --container-xs: 100%;
            --container-sm: 540px;
            --container-md: 720px;
            --container-lg: 960px;
            --container-xl: 1140px;
            --container-2xl: 1320px;
        }
        
        /* CSS Reset and base mobile-first styles */
        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px; /* Base font size for mobile readability */
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            background: var(--vscode-editor-background, var(--background-primary));
            color: var(--vscode-foreground, var(--text-primary));
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
        }
        
        /* Critical above-the-fold content rendering */
        .app-container {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        .app-header {
            flex-shrink: 0;
            background: var(--vscode-titleBar-activeBackground, var(--background-secondary));
            border-bottom: 1px solid var(--vscode-panel-border, var(--border-color));
        }
        
        .app-main {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        /* Critical loading screen styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--vscode-editor-background, var(--background-primary));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--space-xl);
            will-change: opacity, transform;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--vscode-progressBar-background, var(--secondary-color));
            border-top: 3px solid var(--vscode-progressBar-foreground, var(--primary-color));
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-md);
            will-change: transform;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--vscode-foreground, var(--text-primary));
            font-size: var(--font-size-base);
            text-align: center;
            margin-bottom: var(--space-md);
            font-weight: 500;
        }
        
        .loading-progress {
            width: 100%;
            max-width: 300px;
            height: 4px;
            background: var(--vscode-progressBar-background, var(--secondary-color));
            border-radius: var(--border-radius-sm);
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--vscode-progressBar-foreground, var(--primary-color));
            width: 0%;
            transition: width var(--transition-slow);
            will-change: width;
        }
        
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: var(--space-sm);
            background: var(--vscode-button-background, var(--primary-color));
            color: var(--vscode-button-foreground, #ffffff);
            padding: var(--space-sm);
            text-decoration: none;
            border-radius: var(--border-radius-md);
            z-index: var(--z-tooltip);
            font-size: var(--font-size-sm);
            font-weight: 500;
            transition: all var(--transition-fast);
        }
        
        .skip-link:focus {
            top: var(--space-sm);
            outline: 2px solid var(--vscode-focusBorder, var(--focus-color));
            outline-offset: 2px;
        }
        
        /* Loading screen critical styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--vscode-editor-background, #1e1e1e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 2rem;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--vscode-progressBar-background, #454545);
            border-top: 3px solid var(--vscode-progressBar-foreground, #007acc);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--vscode-foreground, #cccccc);
            font-size: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .loading-progress {
            width: 100%;
            max-width: 300px;
            height: 4px;
            background: var(--vscode-progressBar-background, #454545);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--vscode-progressBar-foreground, #007acc);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Touch-optimized interactive elements */
        button, .interactive, .btn, input[type="button"], input[type="submit"], input[type="reset"] {
            min-height: var(--touch-target-min);
            min-width: var(--touch-target-min);
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--vscode-button-border, transparent);
            border-radius: var(--border-radius-md);
            background: var(--vscode-button-background, var(--primary-color));
            color: var(--vscode-button-foreground, #ffffff);
            font-size: var(--font-size-sm);
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            text-decoration: none;
            outline: none;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        
        /* Touch feedback states */
        button:hover, .interactive:hover, .btn:hover {
            background: var(--vscode-button-hoverBackground, var(--primary-hover));
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        button:focus, .interactive:focus, .btn:focus {
            outline: 2px solid var(--vscode-focusBorder, var(--focus-color));
            outline-offset: 2px;
            z-index: 1;
        }
        
        button:active, .interactive:active, .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            background: var(--vscode-button-background, var(--primary-active));
        }
        
        button:disabled, .interactive:disabled, .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Input elements with touch optimization */
        input, textarea, select {
            min-height: var(--touch-target-min);
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--vscode-input-border, var(--border-color));
            border-radius: var(--border-radius-md);
            background: var(--vscode-input-background, var(--background-secondary));
            color: var(--vscode-input-foreground, var(--text-primary));
            font-size: var(--font-size-base);
            font-family: inherit;
            transition: all var(--transition-normal);
            outline: none;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--vscode-focusBorder, var(--focus-color));
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }
        
        /* Link elements with touch targets */
        a {
            color: var(--vscode-textLink-foreground, var(--primary-color));
            text-decoration: none;
            min-height: var(--touch-target-min);
            display: inline-flex;
            align-items: center;
            padding: var(--space-xs) 0;
            transition: color var(--transition-fast);
        }
        
        a:hover {
            color: var(--vscode-textLink-activeForeground, var(--primary-hover));
            text-decoration: underline;
        }
        
        a:focus {
            outline: 2px solid var(--vscode-focusBorder, var(--focus-color));
            outline-offset: 2px;
            border-radius: var(--border-radius-sm);
        }
        
        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            button, .interactive {
                border: 2px solid;
            }
        }
        
        /* Performance optimizations */
        .ui-container {
            contain: layout style paint;
            will-change: auto;
        }
        
        .loading-screen {
            contain: strict;
        }
        
        /* Scroll optimization */
        .scrollable {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* Touch gesture optimizations */
        .touch-action-pan-y {
            touch-action: pan-y;
        }
        
        .touch-action-pan-x {
            touch-action: pan-x;
        }
        
        .touch-action-manipulation {
            touch-action: manipulation;
        }
        
        /* Critical grid and flexbox utilities */
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .flex-wrap {
            flex-wrap: wrap;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-sm {
            gap: var(--space-sm);
        }
        
        .gap-md {
            gap: var(--space-md);
        }
        
        .gap-lg {
            gap: var(--space-lg);
        }
        
        /* Critical spacing utilities */
        .p-sm {
            padding: var(--space-sm);
        }
        
        .p-md {
            padding: var(--space-md);
        }
        
        .p-lg {
            padding: var(--space-lg);
        }
        
        .m-0 {
            margin: 0;
        }
        
        .mb-sm {
            margin-bottom: var(--space-sm);
        }
        
        .mb-md {
            margin-bottom: var(--space-md);
        }
        
        .mb-lg {
            margin-bottom: var(--space-lg);
        }
        
        /* Critical text utilities */
        .text-center {
            text-align: center;
        }
        
        .text-left {
            text-align: left;
        }
        
        .text-right {
            text-align: right;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            
            html {
                scroll-behavior: auto;
            }
            
            .loading-spinner {
                animation: none;
                border-top-color: var(--vscode-progressBar-foreground, var(--primary-color));
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            button, .interactive, .btn {
                border: 2px solid;
                border-color: var(--vscode-contrastBorder, currentColor);
            }
            
            input, textarea, select {
                border: 2px solid;
                border-color: var(--vscode-contrastBorder, currentColor);
            }
            
            .loading-spinner {
                border-width: 4px;
            }
        }
        
        /* Dark theme adjustments */
        .vscode-theme-dark {
            color-scheme: dark;
        }
        
        /* Light theme adjustments */
        .vscode-theme-light {
            color-scheme: light;
            
            --background-primary: #ffffff;
            --background-secondary: #f3f3f3;
            --background-tertiary: #e8e8e8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #d0d0d0;
        }
        
        /* Print styles */
        @media print {
            .loading-screen,
            .ui-toggle,
            button,
            .interactive {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* Container queries for component-level responsiveness */
        .ui-container {
            container-type: inline-size;
            container-name: ui-container;
        }
        
        .app-container {
            container-type: inline-size;
            container-name: app-container;
        }
        
        .section-container {
            container-type: inline-size;
            container-name: section;
        }
        
        /* Container query rules */
        @container ui-container (min-width: 320px) {
            .command-buttons {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: var(--space-sm);
            }
        }
        
        @container ui-container (min-width: 576px) {
            .info-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-md);
            }
            
            .command-buttons {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }
        
        @container ui-container (min-width: 768px) {
            .app-main {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: var(--space-xl);
            }
            
            .info-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .command-buttons {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
        
        @container ui-container (min-width: 992px) {
            .container {
                max-width: var(--container-lg);
                margin: 0 auto;
                padding: 0 var(--space-lg);
            }
            
            .command-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @container ui-container (min-width: 1200px) {
            .container {
                max-width: var(--container-xl);
                padding: 0 var(--space-xl);
            }
            
            .app-main {
                grid-template-columns: 1fr 350px;
            }
        }
        
        /* Mobile-first responsive breakpoints */
        /* Base styles (320px+) - Mobile first */
        .container {
            width: 100%;
            padding: 0 var(--space-md);
            margin: 0 auto;
        }
        
        .app-header {
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--vscode-panel-border, var(--border-color));
            margin-bottom: var(--space-lg);
        }
        
        .section-heading {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: 0 0 var(--space-md) 0;
            color: var(--vscode-foreground, var(--text-primary));
        }
        
        .subsection-heading {
            font-size: var(--font-size-lg);
            font-weight: 500;
            margin: 0 0 var(--space-sm) 0;
            color: var(--vscode-foreground, var(--text-primary));
        }
        
        /* Small devices (576px and up) */
        @media (min-width: 576px) {
            .container {
                max-width: var(--container-sm);
                padding: 0 var(--space-lg);
            }
            
            .app-header {
                padding: var(--space-lg) 0;
            }
            
            .section-heading {
                font-size: var(--font-size-2xl);
            }
            
            .loading-screen {
                padding: var(--space-xl);
            }
            
            .loading-text {
                font-size: var(--font-size-lg);
            }
        }
        
        /* Medium devices (768px and up) - Tablets */
        @media (min-width: 768px) {
            .container {
                max-width: var(--container-md);
                padding: 0 var(--space-xl);
            }
            
            .app-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .section-heading {
                font-size: var(--font-size-3xl);
            }
            
            .command-form {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: var(--space-lg);
                align-items: end;
            }
            
            .execute-btn {
                height: fit-content;
            }
        }
        
        /* Large devices (992px and up) - Desktop */
        @media (min-width: 992px) {
            .container {
                max-width: var(--container-lg);
            }
            
            .app-main {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: var(--space-2xl);
            }
            
            .sidebar-content {
                position: sticky;
                top: var(--space-lg);
                height: fit-content;
            }
            
            .command-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Extra large devices (1200px and up) - Large Desktop */
        @media (min-width: 1200px) {
            .container {
                max-width: var(--container-xl);
            }
            
            .app-main {
                grid-template-columns: 3fr 1fr;
            }
            
            .command-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Extra extra large devices (1400px and up) */
        @media (min-width: 1400px) {
            .container {
                max-width: var(--container-2xl);
            }
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 767px) {
            .loading-screen {
                padding: var(--space-md);
            }
            
            .loading-text {
                font-size: var(--font-size-sm);
            }
            
            .app-title {
                font-size: var(--font-size-lg);
            }
            
            .command-buttons {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
            
            .quick-cmd-btn {
                justify-content: flex-start;
                text-align: left;
            }
            
            .input-group {
                margin-bottom: var(--space-lg);
            }
            
            .state-display {
                display: flex;
                flex-direction: column;
                gap: var(--space-md);
            }
        }
        
        /* Landscape orientation optimizations */
        @media (orientation: landscape) and (max-height: 500px) {
            .loading-screen {
                flex-direction: row;
                gap: var(--space-lg);
            }
            
            .loading-spinner {
                margin-bottom: 0;
            }
            
            .app-header {
                padding: var(--space-sm) 0;
            }
        }
    </style>
    
    <!-- Conditional Styles -->
    <link rel="stylesheet" href="styles/enhanced-main.css" id="mainStyles">
    <link rel="stylesheet" href="styles/basic.css" id="basicStyles">
    <link rel="stylesheet" href="styles/enhanced.css" id="enhancedStyles">
    <link rel="stylesheet" href="styles/components.css" id="componentsStyles">
    <link rel="stylesheet" href="styles/themes.css" id="themesStyles">
    <link rel="stylesheet" href="styles/animations.css" id="animationsStyles">
    <link rel="stylesheet" href="styles/touch.css" id="touchStyles">
</head>

<body class="vscode-theme-dark" role="application" aria-label="VS Code Web Automation Tunnel">
    <!-- Skip navigation for accessibility -->
    <a href="#main-content" class="skip-link" aria-label="Skip to main content">Skip to main content</a>
    
    <!-- Loading screen with accessibility support -->
    <div id="loadingScreen" class="loading-screen" role="status" aria-live="polite" aria-label="Application loading">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div class="loading-text" id="loadingText">Initializing VS Code Web Automation Tunnel...</div>
        <div class="loading-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Loading progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>
    
    <!-- Basic UI Container with semantic structure -->
    <div id="basicApp" class="ui-container basic-ui" style="display: none;" role="main" aria-label="Basic user interface">
        <div class="container">
            <!-- Main header with navigation -->
            <header role="banner" class="app-header">
                <div class="header-content">
                    <h1 class="app-title">VS Code Web Automation Tunnel</h1>
                    <nav role="navigation" aria-label="Connection status and settings">
                        <div class="connection-status" id="basicConnectionStatus" role="status" aria-live="polite">
                            <span class="status-indicator" id="basicStatusIndicator" aria-hidden="true"></span>
                            <span id="basicStatusText" aria-label="Connection status">Connecting...</span>
                        </div>
                    </nav>
                </div>
            </header>

            <!-- Main content area -->
            <main id="main-content" role="main" class="app-main" aria-label="Main application content">
                <!-- Server information section -->
                <section class="server-info" aria-labelledby="server-info-heading">
                    <h2 id="server-info-heading" class="section-heading">Server Information</h2>
                    <div class="info-grid" role="group" aria-label="Server status information">
                        <div class="info-item" role="group">
                            <label for="basicServerUrl" class="info-label">Server URL:</label>
                            <span id="basicServerUrl" class="info-value" aria-live="polite">-</span>
                        </div>
                        <div class="info-item" role="group">
                            <label for="basicWebsocketPort" class="info-label">WebSocket Port:</label>
                            <span id="basicWebsocketPort" class="info-value" aria-live="polite">-</span>
                        </div>
                        <div class="info-item" role="group">
                            <label for="basicConnectedClients" class="info-label">Connected Clients:</label>
                            <span id="basicConnectedClients" class="info-value" aria-live="polite">-</span>
                        </div>
                        <div class="info-item" role="group">
                            <label for="basicUptime" class="info-label">Uptime:</label>
                            <span id="basicUptime" class="info-value" aria-live="polite">-</span>
                        </div>
                    </div>
                </section>

                <!-- Command interface section -->
                <section class="command-interface" aria-labelledby="command-interface-heading">
                    <h2 id="command-interface-heading" class="section-heading">Command Interface</h2>
                    
                    <!-- Quick commands subsection -->
                    <div class="quick-commands" aria-labelledby="quick-commands-heading">
                        <h3 id="quick-commands-heading" class="subsection-heading">Quick Commands</h3>
                        <div class="command-buttons" role="group" aria-label="Quick command buttons">
                            <button class="quick-cmd-btn" data-command="workbench.action.files.newUntitledFile" 
                                    aria-label="Create new untitled file" type="button">
                                <span class="btn-icon" aria-hidden="true">📄</span>
                                <span class="btn-text">New File</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.files.save" 
                                    aria-label="Save current file" type="button">
                                <span class="btn-icon" aria-hidden="true">💾</span>
                                <span class="btn-text">Save File</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.showCommands" 
                                    aria-label="Open command palette" type="button">
                                <span class="btn-icon" aria-hidden="true">⌘</span>
                                <span class="btn-text">Command Palette</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.quickOpen" 
                                    aria-label="Open quick file picker" type="button">
                                <span class="btn-icon" aria-hidden="true">🔍</span>
                                <span class="btn-text">Quick Open</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.toggleSidebarVisibility" 
                                    aria-label="Toggle sidebar visibility" type="button">
                                <span class="btn-icon" aria-hidden="true">📋</span>
                                <span class="btn-text">Toggle Sidebar</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.terminal.toggleTerminal" 
                                    aria-label="Toggle terminal panel" type="button">
                                <span class="btn-icon" aria-hidden="true">💻</span>
                                <span class="btn-text">Toggle Terminal</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="editor.action.formatDocument" 
                                    aria-label="Format current document" type="button">
                                <span class="btn-icon" aria-hidden="true">✨</span>
                                <span class="btn-text">Format Document</span>
                            </button>
                            <button class="quick-cmd-btn" data-command="workbench.action.reloadWindow" 
                                    aria-label="Reload VS Code window" type="button">
                                <span class="btn-icon" aria-hidden="true">🔄</span>
                                <span class="btn-text">Reload Window</span>
                            </button>
                        </div>
                    </div>

                    <!-- Custom command form -->
                    <div class="command-form" aria-labelledby="custom-command-heading">
                        <h3 id="custom-command-heading" class="subsection-heading">Custom Command</h3>
                        <form role="form" aria-label="Custom VS Code command execution">
                            <div class="input-group">
                                <label for="basicCommandInput" class="input-label">VS Code Command:</label>
                                <input type="text" id="basicCommandInput" class="command-input" 
                                       placeholder="e.g., workbench.action.files.newUntitledFile"
                                       aria-describedby="command-help" autocomplete="off" spellcheck="false">
                                <div id="command-help" class="input-help">Enter a VS Code command identifier</div>
                            </div>
                            <div class="input-group">
                                <label for="basicArgsInput" class="input-label">Arguments (JSON):</label>
                                <textarea id="basicArgsInput" class="args-input" rows="3"
                                          placeholder='["arg1", "arg2"] or leave empty'
                                          aria-describedby="args-help" spellcheck="false"></textarea>
                                <div id="args-help" class="input-help">Optional JSON array of command arguments</div>
                            </div>
                            <button id="basicExecuteButton" type="button" class="execute-btn" disabled 
                                    aria-label="Execute the custom command">
                                <span class="btn-icon" aria-hidden="true">▶️</span>
                                <span class="btn-text">Execute Command</span>
                            </button>
                        </form>
                    </div>
                </section>

                <!-- Workspace state section -->
                <section class="workspace-state" aria-labelledby="workspace-state-heading">
                    <h2 id="workspace-state-heading" class="section-heading">VS Code State</h2>
                    <div class="state-display" role="group" aria-label="Current VS Code workspace state">
                        <div class="state-section" aria-labelledby="active-editor-heading">
                            <h3 id="active-editor-heading" class="subsection-heading">Active Editor</h3>
                            <div id="basicActiveEditor" class="state-value" role="status" aria-live="polite" 
                                 aria-label="Currently active editor">No active editor</div>
                        </div>
                        <div class="state-section" aria-labelledby="workspace-folders-heading">
                            <h3 id="workspace-folders-heading" class="subsection-heading">Workspace Folders</h3>
                            <div id="basicWorkspaceFolders" class="state-value" role="status" aria-live="polite"
                                 aria-label="Open workspace folders">No workspace folders</div>
                        </div>
                        <div class="state-section" aria-labelledby="open-editors-heading">
                            <h3 id="open-editors-heading" class="subsection-heading">Open Editors</h3>
                            <div id="basicOpenEditors" class="state-value" role="status" aria-live="polite"
                                 aria-label="List of open editors">No open editors</div>
                        </div>
                    </div>
                </section>

                <!-- Message log section -->
                <section class="message-log" aria-labelledby="message-log-heading">
                    <h2 id="message-log-heading" class="section-heading">Message Log</h2>
                    <div class="log-controls" role="toolbar" aria-label="Log controls">
                        <button id="basicClearLogButton" type="button" class="clear-log-btn" 
                                aria-label="Clear all log messages">
                            <span class="btn-icon" aria-hidden="true">🗑️</span>
                            <span class="btn-text">Clear Log</span>
                        </button>
                    </div>
                    <div class="log-container" id="basicMessageLog" role="log" aria-live="polite" 
                         aria-label="Application message log" tabindex="0"></div>
                </section>
            </main>
        </div>
    </div>

    <!-- Enhanced UI Container with semantic structure -->
    <div id="enhancedApp" class="ui-container enhanced-ui app-container" style="display: none;" 
         role="main" aria-label="Enhanced user interface">
        <!-- App Shell will be rendered here by enhanced UI components -->
        <div id="app" class="app-shell" role="application" aria-label="Enhanced VS Code automation interface">
            <!-- Enhanced UI components will be dynamically loaded here -->
        </div>
    </div>

    <!-- UI Mode Toggle (for development/debugging) -->
    <div class="ui-toggle" id="uiToggle" role="complementary" aria-label="Development tools"
         style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">
        <button id="toggleUIButton" type="button" class="toggle-btn" 
                aria-label="Toggle between basic and enhanced UI modes" title="Toggle UI Mode">
            <span aria-hidden="true">🔄</span>
            <span class="sr-only">Toggle UI</span>
        </button>
    </div>
    
    <!-- Accessibility and no-JavaScript fallback -->
    <noscript>
        <div class="no-js-fallback" role="alert" aria-live="assertive">
            <div class="fallback-container">
                <header class="fallback-header">
                    <h1>JavaScript Required</h1>
                    <p class="fallback-subtitle">VS Code Web Automation Tunnel</p>
                </header>
                
                <main class="fallback-content">
                    <section class="fallback-message">
                        <h2>Enable JavaScript to Continue</h2>
                        <p>This application requires JavaScript to provide the full VS Code automation experience. 
                           Please enable JavaScript in your browser settings and refresh the page.</p>
                    </section>
                    
                    <section class="fallback-instructions">
                        <h3>How to Enable JavaScript:</h3>
                        <details>
                            <summary>Chrome/Edge</summary>
                            <ol>
                                <li>Click the three dots menu → Settings</li>
                                <li>Go to Privacy and security → Site Settings</li>
                                <li>Click JavaScript → Allow sites to use JavaScript</li>
                                <li>Refresh this page</li>
                            </ol>
                        </details>
                        <details>
                            <summary>Firefox</summary>
                            <ol>
                                <li>Type "about:config" in the address bar</li>
                                <li>Search for "javascript.enabled"</li>
                                <li>Set the value to "true"</li>
                                <li>Refresh this page</li>
                            </ol>
                        </details>
                        <details>
                            <summary>Safari</summary>
                            <ol>
                                <li>Safari menu → Preferences → Security</li>
                                <li>Check "Enable JavaScript"</li>
                                <li>Refresh this page</li>
                            </ol>
                        </details>
                    </section>
                    
                    <section class="fallback-alternative">
                        <h3>Alternative Access</h3>
                        <p>If you cannot enable JavaScript, you can still access VS Code directly:</p>
                        <ul>
                            <li>Open VS Code desktop application</li>
                            <li>Use VS Code in your browser at <a href="https://vscode.dev" target="_blank" rel="noopener">vscode.dev</a></li>
                            <li>Install the VS Code extension locally</li>
                        </ul>
                    </section>
                </main>
                
                <footer class="fallback-footer">
                    <p>For technical support, please refer to the VS Code documentation or contact your system administrator.</p>
                </footer>
            </div>
        </div>
        
        <style>
            .no-js-fallback {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #1e1e1e;
                color: #cccccc;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 1rem;
                box-sizing: border-box;
            }
            
            .fallback-container {
                max-width: 600px;
                text-align: center;
                line-height: 1.6;
            }
            
            .fallback-header h1 {
                color: #f14c4c;
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }
            
            .fallback-subtitle {
                color: #9d9d9d;
                font-size: 1.1rem;
                margin-bottom: 2rem;
            }
            
            .fallback-content {
                text-align: left;
            }
            
            .fallback-message {
                background: #2d2d30;
                padding: 1.5rem;
                border-radius: 8px;
                margin-bottom: 2rem;
                border-left: 4px solid #007acc;
            }
            
            .fallback-instructions details {
                margin: 1rem 0;
                background: #2d2d30;
                padding: 1rem;
                border-radius: 4px;
            }
            
            .fallback-instructions summary {
                cursor: pointer;
                font-weight: bold;
                color: #007acc;
                margin-bottom: 0.5rem;
            }
            
            .fallback-instructions ol {
                margin: 0.5rem 0 0 1rem;
            }
            
            .fallback-alternative {
                background: #2d2d30;
                padding: 1.5rem;
                border-radius: 8px;
                margin: 2rem 0;
            }
            
            .fallback-alternative a {
                color: #007acc;
                text-decoration: none;
            }
            
            .fallback-alternative a:hover {
                text-decoration: underline;
            }
            
            .fallback-footer {
                margin-top: 2rem;
                padding-top: 1rem;
                border-top: 1px solid #454545;
                color: #9d9d9d;
                font-size: 0.9rem;
            }
            
            @media (max-width: 768px) {
                .fallback-container {
                    padding: 1rem;
                }
                
                .fallback-header h1 {
                    font-size: 1.5rem;
                }
            }
        </style>
    </noscript>

    <!-- Adaptive JavaScript Loader -->
    <script>
        // Global configuration
        window.webAutomationConfig = {
            isVSCodeWebview: typeof acquireVsCodeApi !== 'undefined',
            vscode: null,
            useEnhancedUI: true, // Will be set dynamically
            debugMode: false
        };

        // Initialize VS Code API if available
        if (window.webAutomationConfig.isVSCodeWebview) {
            try {
                window.webAutomationConfig.vscode = acquireVsCodeApi();
                window.vscode = window.webAutomationConfig.vscode;
            } catch (error) {
                console.warn('Failed to acquire VS Code API:', error);
            }
        }

        // Enhanced UI Loader with Intelligent Decision Making and Fallback Mechanisms
        class EnhancedUILoader {
            constructor() {
                this.loadingState = 'initializing';
                this.progressSteps = [];
                this.currentStep = 0;
                this.retryCount = 0;
                this.maxRetries = 3;
                this.loadingTimeout = 30000; // 30 seconds
                this.progressiveEnhancement = null;
                this.loadingStrategy = null;
                this.errorHistory = [];
                
                // Loading step definitions
                this.loadingSteps = [
                    { id: 'detection', name: 'Detecting capabilities...', weight: 15 },
                    { id: 'strategy', name: 'Determining strategy...', weight: 10 },
                    { id: 'resources', name: 'Loading resources...', weight: 30 },
                    { id: 'initialization', name: 'Initializing components...', weight: 35 },
                    { id: 'finalization', name: 'Finalizing setup...', weight: 10 }
                ];
                
                // Bind methods
                this.handleLoadingError = this.handleLoadingError.bind(this);
                this.updateProgress = this.updateProgress.bind(this);
            }
            
            async initialize() {
                try {
                    console.log('🚀 Starting Enhanced UI Loader...');
                    this.updateLoadingState('initializing');
                    
                    // Set up loading timeout with recovery
                    const loadingTimeout = setTimeout(() => {
                        this.handleLoadingTimeout();
                    }, this.loadingTimeout);
                    
                    // Detect UI mode from URL parameters or configuration
                    const urlParams = new URLSearchParams(window.location.search);
                    const uiMode = urlParams.get('ui') || 'auto';
                    const debugMode = urlParams.has('debug');
                    
                    window.webAutomationConfig.debugMode = debugMode;
                    
                    // Show debug toggle in debug mode
                    if (debugMode) {
                        document.getElementById('uiToggle').style.display = 'block';
                    }
                    
                    // Step 1: Progressive Enhancement Detection
                    this.updateStep('detection');
                    const enhancementDecision = await this.performCapabilityDetection();
                    
                    // Step 2: Strategy Determination
                    this.updateStep('strategy');
                    const loadingStrategy = await this.determineLoadingStrategy(enhancementDecision, uiMode);
                    
                    // Step 3: Load UI based on strategy
                    this.updateStep('resources');
                    const uiInstance = await this.loadUIWithFallback(loadingStrategy);
                    
                    // Step 4: Initialize UI components
                    this.updateStep('initialization');
                    await this.initializeUIComponents(uiInstance, loadingStrategy);
                    
                    // Step 5: Finalize setup
                    this.updateStep('finalization');
                    await this.finalizeUISetup(uiInstance, loadingStrategy);
                    
                    clearTimeout(loadingTimeout);
                    
                    // Smooth transition to hide loading screen
                    await this.hideLoadingScreenWithTransition();
                    
                    console.log('✅ Enhanced UI Loader completed successfully');
                    this.updateLoadingState('completed');
                    
                    return uiInstance;
                    
                } catch (error) {
                    console.error('❌ Enhanced UI Loader failed:', error);
                    return this.handleLoadingError(error);
                }
            }
            
            async performCapabilityDetection() {
                try {
                    // Initialize progressive enhancement system if available
                    if (typeof ProgressiveEnhancement !== 'undefined') {
                        this.progressiveEnhancement = new ProgressiveEnhancement();
                        const decision = await this.progressiveEnhancement.initialize();
                        console.log('📊 Progressive enhancement decision:', decision);
                        return decision;
                    }
                    
                    // Fallback capability detection
                    return this.basicCapabilityDetection();
                    
                } catch (error) {
                    console.warn('⚠️ Progressive enhancement failed, using basic detection:', error);
                    return this.basicCapabilityDetection();
                }
            }
            
            basicCapabilityDetection() {
                const capabilities = {
                    touchSupport: 'ontouchstart' in window,
                    highDPI: window.devicePixelRatio > 1,
                    serviceWorker: 'serviceWorker' in navigator,
                    intersectionObserver: 'IntersectionObserver' in window,
                    webGL: !!this.detectWebGL(),
                    localStorage: this.testLocalStorage(),
                    deviceMemory: navigator.deviceMemory || 4,
                    connectionSpeed: navigator.connection?.effectiveType || '4g'
                };
                
                const networkConditions = {
                    effectiveType: navigator.connection?.effectiveType || '4g',
                    saveData: navigator.connection?.saveData || false,
                    quality: this.assessNetworkQuality()
                };
                
                const performanceMetrics = {
                    deviceClass: this.classifyDevice(capabilities),
                    loadTime: performance.now()
                };
                
                return {
                    capabilities,
                    networkConditions,
                    performanceMetrics,
                    loadingStrategy: { useEnhancedUI: true }
                };
            }
            
            detectWebGL() {
                try {
                    const canvas = document.createElement('canvas');
                    return !!canvas.getContext('webgl') || !!canvas.getContext('experimental-webgl');
                } catch (e) {
                    return false;
                }
            }
            
            testLocalStorage() {
                try {
                    const test = '__test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            assessNetworkQuality() {
                const connection = navigator.connection;
                if (!connection) return 'good';
                
                const effectiveType = connection.effectiveType;
                if (effectiveType === '4g') return 'excellent';
                if (effectiveType === '3g') return 'good';
                if (effectiveType === 'slow-2g' || effectiveType === '2g') return 'poor';
                return 'fair';
            }
            
            classifyDevice(capabilities) {
                const memory = capabilities.deviceMemory || 4;
                const hasWebGL = capabilities.webGL;
                const isHighDPI = capabilities.highDPI;
                
                if (memory >= 8 && hasWebGL && isHighDPI) return 'high-end';
                if (memory >= 4 && (hasWebGL || isHighDPI)) return 'mid-range';
                return 'low-end';
            }
            
            async determineLoadingStrategy(enhancementDecision, requestedMode) {
                const { capabilities, networkConditions, performanceMetrics } = enhancementDecision;
                
                // Handle explicit mode requests
                if (requestedMode === 'enhanced') {
                    return { useEnhancedUI: true, forced: true };
                }
                if (requestedMode === 'basic') {
                    return { useEnhancedUI: false, forced: true };
                }
                
                // Auto-detection logic
                const shouldUseEnhanced = (
                    performanceMetrics.deviceClass !== 'low-end' &&
                    networkConditions.quality !== 'poor' &&
                    !networkConditions.saveData &&
                    capabilities.serviceWorker &&
                    capabilities.intersectionObserver
                );
                
                const strategy = {
                    useEnhancedUI: shouldUseEnhanced,
                    lazyLoad: networkConditions.quality === 'fair' || networkConditions.quality === 'poor',
                    enableAnimations: performanceMetrics.deviceClass === 'high-end',
                    preloadCritical: networkConditions.quality === 'excellent',
                    compressionLevel: networkConditions.saveData ? 'maximum' : 'standard'
                };
                
                console.log('📋 Loading strategy determined:', strategy);
                this.loadingStrategy = strategy;
                window.webAutomationConfig.useEnhancedUI = strategy.useEnhancedUI;
                
                return strategy;
            }
            
            async loadUIWithFallback(strategy) {
                this.retryCount = 0;
                
                while (this.retryCount <= this.maxRetries) {
                    try {
                        if (strategy.useEnhancedUI) {
                            console.log(`🎨 Attempting to load Enhanced UI (attempt ${this.retryCount + 1})...`);
                            return await this.loadEnhancedUIWithRecovery();
                        } else {
                            console.log(`🔧 Loading Basic UI...`);
                            return await this.loadBasicUIWithRecovery();
                        }
                    } catch (error) {
                        this.errorHistory.push({ error, attempt: this.retryCount + 1, timestamp: Date.now() });
                        console.warn(`⚠️ UI loading attempt ${this.retryCount + 1} failed:`, error);
                        
                        this.retryCount++;
                        
                        if (this.retryCount <= this.maxRetries) {
                            // Try fallback on next attempt
                            if (strategy.useEnhancedUI && this.retryCount > 1) {
                                console.log('🔄 Falling back to Basic UI...');
                                strategy.useEnhancedUI = false;
                                window.webAutomationConfig.useEnhancedUI = false;
                            }
                            
                            // Show retry message
                            this.updateLoadingText(`Retrying... (${this.retryCount}/${this.maxRetries})`);
                            await this.delay(1000 * this.retryCount); // Exponential backoff
                        } else {
                            // Final fallback
                            throw new Error(`All UI loading attempts failed after ${this.maxRetries} retries`);
                        }
                    }
                }
            }
            
            async loadEnhancedUIWithRecovery() {
                // Show enhanced container
                document.getElementById('enhancedApp').style.display = 'block';
                document.getElementById('basicApp').style.display = 'none';
                
                // Load enhanced styles with fallback
                this.updateLoadingText('Loading enhanced styles...');
                this.enableStylesheets(['enhancedStyles', 'componentsStyles', 'themesStyles', 'animationsStyles', 'touchStyles']);
                this.disableStylesheets(['basicStyles']);
                
                // Set up enhanced UI container elements
                const enhancedContainer = document.getElementById('enhancedApp');
                let appElement = document.getElementById('app');
                if (!appElement) {
                    appElement = document.createElement('div');
                    appElement.id = 'app';
                    appElement.className = 'app-container';
                    enhancedContainer.appendChild(appElement);
                }
                
                // Load enhanced JavaScript with timeout and retry
                this.updateLoadingText('Loading enhanced components...');
                await this.loadScriptWithRetry('./js/enhanced.js', 'EnhancedApp');
                
                // Create and return enhanced app instance
                if (typeof window.EnhancedApp !== 'undefined') {
                    return new window.EnhancedApp();
                } else if (typeof window.EnhancedWebApp !== 'undefined') {
                    return new window.EnhancedWebApp();
                } else {
                    throw new Error('Enhanced UI class not found after loading script');
                }
            }
            
            async loadBasicUIWithRecovery() {
                // Show basic container
                document.getElementById('basicApp').style.display = 'block';
                document.getElementById('enhancedApp').style.display = 'none';
                
                // Load basic styles
                this.updateLoadingText('Loading basic interface...');
                this.enableStylesheets(['basicStyles']);
                this.disableStylesheets(['enhancedStyles', 'componentsStyles', 'themesStyles', 'animationsStyles', 'touchStyles']);
                
                // Update element IDs for basic UI compatibility
                this.updateBasicUIElementIds();
                
                // Load basic JavaScript with timeout and retry
                this.updateLoadingText('Initializing basic components...');
                await this.loadScriptWithRetry('./js/basic.js', 'BasicApp');
                
                // Create and return basic app instance
                if (typeof window.BasicApp !== 'undefined') {
                    return new window.BasicApp();
                } else {
                    throw new Error('Basic UI class not found after loading script');
                }
            }
            
            async loadScriptWithRetry(src, expectedClass, retries = 3) {
                for (let attempt = 1; attempt <= retries; attempt++) {
                    try {
                        await this.loadScript(src);
                        
                        // Verify the expected class is available
                        if (expectedClass && !window[expectedClass]) {
                            throw new Error(`Expected class ${expectedClass} not found after loading ${src}`);
                        }
                        
                        return;
                    } catch (error) {
                        if (attempt === retries) {
                            throw error;
                        }
                        console.warn(`Script loading attempt ${attempt} failed, retrying...`, error);
                        await this.delay(500 * attempt);
                    }
                }
            }
            
            enableStylesheets(ids) {
                ids.forEach(id => {
                    const stylesheet = document.getElementById(id);
                    if (stylesheet) stylesheet.disabled = false;
                });
            }
            
            disableStylesheets(ids) {
                ids.forEach(id => {
                    const stylesheet = document.getElementById(id);
                    if (stylesheet) stylesheet.disabled = true;
                });
            }
            
            async initializeUIComponents(uiInstance, strategy) {
                if (!uiInstance) {
                    throw new Error('No UI instance to initialize');
                }
                
                this.updateLoadingText('Initializing UI components...');
                
                // Initialize with timeout
                const initTimeout = setTimeout(() => {
                    throw new Error('UI initialization timeout');
                }, 15000);
                
                try {
                    if (typeof uiInstance.initialize === 'function') {
                        await uiInstance.initialize();
                    }
                    
                    clearTimeout(initTimeout);
                    
                    // Store reference for later use
                    if (strategy.useEnhancedUI) {
                        window.enhancedApp = uiInstance;
                    } else {
                        window.basicApp = uiInstance;
                    }
                    
                } catch (error) {
                    clearTimeout(initTimeout);
                    throw error;
                }
            }
            
            async finalizeUISetup(uiInstance, strategy) {
                this.updateLoadingText('Finalizing setup...');
                
                // Set up message handling for VS Code webview
                if (window.webAutomationConfig.isVSCodeWebview) {
                    window.addEventListener('message', event => {
                        const message = event.data;
                        if (uiInstance && typeof uiInstance.handleMessage === 'function') {
                            uiInstance.handleMessage(message);
                        }
                    });
                }
                
                // Final progress update
                this.updateProgress(100);
                this.updateLoadingText('Ready!');
                
                // Brief delay for user feedback
                await this.delay(500);
            }
            
            async hideLoadingScreenWithTransition() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (!loadingScreen) return;
                
                // Add fade-out class with animation
                loadingScreen.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                loadingScreen.style.opacity = '0';
                loadingScreen.style.transform = 'scale(0.95)';
                
                // Wait for animation to complete
                await this.delay(500);
                
                // Remove from DOM
                if (loadingScreen.parentNode) {
                    loadingScreen.parentNode.removeChild(loadingScreen);
                }
            }
            
            handleLoadingTimeout() {
                console.error('❌ UI loading timeout after', this.loadingTimeout, 'ms');
                
                const errorScreen = this.createTimeoutErrorScreen();
                document.body.appendChild(errorScreen);
            }
            
            async handleLoadingError(error) {
                console.error('❌ Critical loading error:', error);
                
                // Try emergency fallback to basic UI
                try {
                    console.log('🚨 Attempting emergency fallback to basic UI...');
                    
                    this.updateLoadingText('Attempting emergency recovery...');
                    
                    const basicApp = await this.loadBasicUIWithRecovery();
                    await this.initializeUIComponents(basicApp, { useEnhancedUI: false });
                    await this.hideLoadingScreenWithTransition();
                    
                    // Show recovery notification
                    this.showRecoveryNotification();
                    
                    return basicApp;
                    
                } catch (emergencyError) {
                    console.error('❌ Emergency fallback failed:', emergencyError);
                    
                    // Show critical error screen
                    const errorScreen = this.createCriticalErrorScreen(error, emergencyError);
                    document.body.appendChild(errorScreen);
                    
                    throw new Error('Complete UI loading failure');
                }
            }
            
            updateStep(stepId) {
                this.currentStep++;
                const step = this.loadingSteps.find(s => s.id === stepId);
                if (step) {
                    console.log(`📋 Step ${this.currentStep}/${this.loadingSteps.length}: ${step.name}`);
                    this.updateLoadingText(step.name);
                    
                    // Calculate progress based on completed steps
                    const completedWeight = this.loadingSteps.slice(0, this.currentStep - 1)
                        .reduce((sum, s) => sum + s.weight, 0);
                    const progress = (completedWeight / 100) * 100;
                    this.updateProgress(Math.min(progress, 95)); // Cap at 95% until completion
                }
            }
            
            updateLoadingState(state) {
                this.loadingState = state;
                console.log(`🔄 Loading state: ${state}`);
            }
            
            updateLoadingText(text) {
                const loadingText = document.getElementById('loadingText');
                if (loadingText) {
                    loadingText.textContent = text;
                }
            }
            
            updateProgress(percentage) {
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = `${Math.min(percentage, 100)}%`;
                }
                
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.setAttribute('aria-valuenow', percentage.toString());
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // UI Mode Detection and Loading (Updated)
        async function initializeUI() {
            const loader = new EnhancedUILoader();
            return await loader.initialize();
        }

        // Legacy UI Loading Functions (Updated for compatibility)
        async function loadEnhancedUI() {
            console.log('🎨 Loading Enhanced UI (legacy function)...');
            
            // Show enhanced container
            document.getElementById('enhancedApp').style.display = 'block';
            document.getElementById('basicApp').style.display = 'none';
            
            // Load enhanced styles only
            document.getElementById('basicStyles').disabled = true;
            document.getElementById('enhancedStyles').disabled = false;
            document.getElementById('componentsStyles').disabled = false;
            document.getElementById('themesStyles').disabled = false;
            document.getElementById('animationsStyles').disabled = false;
            document.getElementById('touchStyles').disabled = false;

            console.log('Enhanced styles loaded');

            // Set up enhanced UI container elements
            const enhancedContainer = document.getElementById('enhancedApp');
            
            // Create app element if it doesn't exist (enhanced UI expects 'app' id)
            let appElement = document.getElementById('app');
            if (!appElement) {
                appElement = document.createElement('div');
                appElement.id = 'app';
                appElement.className = 'app-container';
                enhancedContainer.appendChild(appElement);
            }

            console.log('Enhanced UI container prepared');

            // Implement 30-second timeout mechanism
            const initializationTimeout = setTimeout(() => {
                console.error('❌ Enhanced UI initialization timeout (30 seconds)');
                showTimeoutError();
            }, 30000);

            // Load enhanced JavaScript modules with graceful degradation
            try {
                console.log('Loading Enhanced JavaScript modules...');
                
                // Use traditional script loading instead of dynamic imports
                await loadScript('./js/enhanced.js');
                
                console.log('Enhanced modules loaded, initializing app...');
                
                // Check if EnhancedApp class is available
                if (typeof window.EnhancedApp !== 'undefined') {
                    window.enhancedApp = new window.EnhancedApp();
                    await window.enhancedApp.initialize();
                    
                    console.log('Enhanced UI initialization complete ✅');
                    clearTimeout(initializationTimeout);
                } else if (typeof window.EnhancedWebApp !== 'undefined') {
                    window.enhancedApp = new window.EnhancedWebApp();
                    await window.enhancedApp.initialize();
                    
                    console.log('Enhanced Web UI initialization complete ✅');
                    clearTimeout(initializationTimeout);
                } else {
                    throw new Error('Enhanced UI class not found after loading script');
                }
                
            } catch (error) {
                clearTimeout(initializationTimeout);
                console.error('❌ Failed to load enhanced UI:', error);
                
                // Graceful degradation - fallback to basic UI
                console.log('🔄 Falling back to Basic UI due to Enhanced UI failure');
                await loadBasicUI();
            }
        }

        // Load Basic UI (Updated)
        async function loadBasicUI() {
            console.log('🔧 Loading Basic UI (legacy function)...');
            
            // Show basic container
            document.getElementById('basicApp').style.display = 'block';
            document.getElementById('enhancedApp').style.display = 'none';
            
            // Load basic styles only
            document.getElementById('basicStyles').disabled = false;
            document.getElementById('enhancedStyles').disabled = true;
            document.getElementById('componentsStyles').disabled = true;
            document.getElementById('themesStyles').disabled = true;
            document.getElementById('animationsStyles').disabled = true;
            document.getElementById('touchStyles').disabled = true;

            console.log('Basic styles loaded');

            // Update element IDs for basic UI (it expects elements without 'basic' prefix)
            updateBasicUIElementIds();

            console.log('Basic UI elements prepared');

            // Implement 30-second timeout mechanism
            const initializationTimeout = setTimeout(() => {
                console.error('❌ Basic UI initialization timeout (30 seconds)');
                showTimeoutError();
            }, 30000);

            // Load basic JavaScript
            try {
                // Use traditional script loading instead of dynamic imports
                await loadScript('./js/basic.js');
                
                // Check if BasicApp class is available
                if (typeof window.BasicApp !== 'undefined') {
                    window.basicApp = new window.BasicApp();
                    await window.basicApp.initialize();
                    
                    console.log('Basic UI initialization complete ✅');
                    clearTimeout(initializationTimeout);
                } else {
                    throw new Error('BasicApp class not found after loading script');
                }
                
            } catch (error) {
                clearTimeout(initializationTimeout);
                console.error('❌ Failed to load basic UI:', error);
                
                // Show final error screen
                showFinalErrorScreen(error);
            }
        }

        // Enhanced Error Handling and Recovery Functions
        
        // Create timeout error screen with recovery options
        EnhancedUILoader.prototype.createTimeoutErrorScreen = function() {
            return this.createErrorScreen(
                'Initialization Timeout',
                'The UI failed to load within 30 seconds. This may be due to missing dependencies or network issues.',
                [
                    { text: 'Retry Enhanced UI', action: () => { window.location.search = '?ui=enhanced'; location.reload(); } },
                    { text: 'Try Basic UI', action: () => { window.location.search = '?ui=basic'; location.reload(); } },
                    { text: 'Debug Mode', action: () => { window.location.search = '?debug&ui=enhanced'; location.reload(); } },
                    { text: 'Force Reload', action: () => location.reload() }
                ]
            );
        };
        
        // Create critical error screen
        EnhancedUILoader.prototype.createCriticalErrorScreen = function(primaryError, emergencyError) {
            const combinedError = new Error(
                `Primary: ${primaryError.message}\nEmergency: ${emergencyError.message}`
            );
            combinedError.stack = `Primary Error:\n${primaryError.stack}\n\nEmergency Error:\n${emergencyError.stack}`;
            
            return this.createErrorScreen(
                'Critical UI Failure',
                'Both Enhanced and Basic UIs failed to load. The application cannot start properly.',
                [
                    { text: 'Reload Page', action: () => location.reload() },
                    { text: 'Clear Cache & Reload', action: () => { 
                        if ('caches' in window) {
                            caches.keys().then(names => {
                                names.forEach(name => caches.delete(name));
                                location.reload();
                            });
                        } else {
                            location.reload(true);
                        }
                    }},
                    { text: 'Report Issue', action: () => window.open('https://github.com/microsoft/vscode/issues/new', '_blank') },
                    { text: 'Download Logs', action: () => this.downloadErrorLogs() }
                ],
                combinedError
            );
        };
        
        // Show recovery notification
        EnhancedUILoader.prototype.showRecoveryNotification = function() {
            const notification = document.createElement('div');
            notification.className = 'recovery-notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: var(--vscode-notifications-background, #2d2d30); color: var(--vscode-notifications-foreground, #cccccc); padding: 16px; border-radius: 8px; border-left: 4px solid var(--warning-color, #ffcc02); z-index: 10001; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 400px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="font-size: 20px;">⚠️</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 8px;">UI Recovery Mode</div>
                            <div style="font-size: 14px; line-height: 1.4; margin-bottom: 12px;">Enhanced UI failed to load. Running in Basic UI mode with reduced features.</div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" style="background: var(--vscode-button-background, #0e639c); color: var(--vscode-button-foreground, #ffffff); border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Dismiss</button>
                                <button onclick="window.location.search='?ui=enhanced&debug'; location.reload();" style="background: transparent; color: var(--vscode-textLink-foreground, #4daafc); border: 1px solid currentColor; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Debug Mode</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        };
        
        // Download error logs for debugging
        EnhancedUILoader.prototype.downloadErrorLogs = function() {
            const errorData = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                errorHistory: this.errorHistory,
                capabilities: this.progressiveEnhancement?.capabilities || 'Not detected',
                networkConditions: this.progressiveEnhancement?.networkConditions || 'Not detected',
                loadingStrategy: this.loadingStrategy || 'Not determined',
                consoleLogs: console.history || 'Console history not available'
            };
            
            const blob = new Blob([JSON.stringify(errorData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vscode-ui-error-log-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        
        // Create standardized error screen (Enhanced version)
        EnhancedUILoader.prototype.createErrorScreen = function(title, message, actions = [], error = null) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'enhanced-error-screen';
            
            let errorDetails = '';
            if (error) {
                errorDetails = `
                    <details style="margin: 1.5rem 0; text-align: left; background: var(--vscode-textCodeBlock-background, #2d2d30); border-radius: 6px; padding: 1rem;">
                        <summary style="cursor: pointer; font-weight: 600; padding: 8px; color: var(--vscode-textLink-foreground, #4daafc);">Technical Details & Stack Trace</summary>
                        <div style="margin-top: 1rem; font-family: 'Courier New', Consolas, monospace; font-size: 11px; line-height: 1.4; white-space: pre-wrap; background: var(--vscode-editor-background, #1e1e1e); padding: 12px; border-radius: 4px; overflow: auto; max-height: 300px; border: 1px solid var(--vscode-widget-border, #454545);">${error.message}\n\n${error.stack || ''}</div>
                    </details>
                `;
            }
            
            const actionButtons = actions.map(action => 
                `<button onclick="(${action.action.toString()})()" style="
                    background: var(--vscode-button-background, #0e639c); 
                    color: var(--vscode-button-foreground, #ffffff); 
                    border: none; 
                    padding: 12px 20px; 
                    margin: 6px; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 14px; 
                    font-weight: 500;
                    transition: background-color 0.2s ease;
                    min-width: 120px;
                " onmouseover="this.style.background='var(--vscode-button-hoverBackground, #1177bb)'" onmouseout="this.style.background='var(--vscode-button-background, #0e639c)'">${action.text}</button>`
            ).join('');
            
            errorContainer.innerHTML = `
                <div style="
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    right: 0; 
                    bottom: 0; 
                    background: var(--vscode-editor-background, #1e1e1e); 
                    color: var(--vscode-foreground, #cccccc); 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    z-index: 10000; 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    padding: 2rem;
                    box-sizing: border-box;
                ">
                    <div style="
                        max-width: 700px; 
                        width: 100%; 
                        text-align: center;
                        background: var(--vscode-sideBar-background, #252526);
                        border-radius: 12px;
                        padding: 2.5rem;
                        border: 1px solid var(--vscode-widget-border, #454545);
                        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                    ">
                        <div style="
                            font-size: 48px; 
                            margin-bottom: 1rem;
                            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
                        ">⚠️</div>
                        <h1 style="
                            color: var(--vscode-errorForeground, #f14c4c); 
                            font-size: 28px; 
                            margin-bottom: 16px;
                            font-weight: 600;
                        ">${title}</h1>
                        <p style="
                            font-size: 16px; 
                            line-height: 1.6; 
                            margin-bottom: 24px;
                            color: var(--vscode-descriptionForeground, #9d9d9d);
                        ">${message}</p>
                        ${errorDetails}
                        <div style="
                            display: flex; 
                            gap: 1rem; 
                            justify-content: center; 
                            margin-top: 2rem; 
                            flex-wrap: wrap;
                        ">
                            ${actionButtons}
                        </div>
                        <div style="
                            margin-top: 2.5rem; 
                            padding-top: 1.5rem; 
                            border-top: 1px solid var(--vscode-widget-border, #454545); 
                            color: var(--vscode-descriptionForeground, #9d9d9d); 
                            font-size: 13px;
                            line-height: 1.5;
                        ">
                            <p style="margin: 0 0 8px 0; font-weight: 600;">VS Code Web Automation Tunnel</p>
                            <p style="margin: 0;">If this problem persists, please check the browser console (F12) for additional information or try refreshing the page.</p>
                        </div>
                    </div>
                </div>
            `;
            
            return errorContainer;
        };
        
        // Update Basic UI element IDs (remove 'basic' prefix for compatibility)
        function updateBasicUIElementIds() {
            const elementMapping = {
                'basicConnectionStatus': 'connectionStatus',
                'basicStatusIndicator': 'statusIndicator', 
                'basicStatusText': 'statusText',
                'basicServerUrl': 'serverUrl',
                'basicWebsocketPort': 'websocketPort',
                'basicConnectedClients': 'connectedClients',
                'basicUptime': 'uptime',
                'basicCommandInput': 'commandInput',
                'basicArgsInput': 'argsInput',
                'basicExecuteButton': 'executeButton',
                'basicActiveEditor': 'activeEditor',
                'basicWorkspaceFolders': 'workspaceFolders',
                'basicOpenEditors': 'openEditors',
                'basicMessageLog': 'messageLog',
                'basicClearLogButton': 'clearLogButton'
            };

            for (const [basicId, targetId] of Object.entries(elementMapping)) {
                const element = document.getElementById(basicId);
                if (element && !document.getElementById(targetId)) {
                    element.id = targetId;
                }
            }
        }

        // Legacy Error Handling Functions (Updated for compatibility)
        
        // Show timeout error screen (Legacy compatibility)
        function showTimeoutError() {
            const errorScreen = createErrorScreen(
                'Initialization Timeout',
                'The UI failed to load within 30 seconds. This may be due to missing dependencies or network issues.',
                [
                    { text: 'Retry', action: () => location.reload() },
                    { text: 'Try Basic UI', action: () => { window.location.search = '?ui=basic'; location.reload(); } },
                    { text: 'Debug Mode', action: () => { window.location.search = '?debug&ui=' + (window.webAutomationConfig.useEnhancedUI ? 'enhanced' : 'basic'); location.reload(); } }
                ]
            );
            document.body.appendChild(errorScreen);
        }

        // Show final error screen when both UIs fail (Legacy compatibility)
        function showFinalErrorScreen(error) {
            const errorScreen = createErrorScreen(
                'Critical UI Failure',
                'Both Enhanced and Basic UIs failed to load. Please check the browser console for details.',
                [
                    { text: 'Reload Page', action: () => location.reload() },
                    { text: 'Report Issue', action: () => window.open('https://github.com/microsoft/vscode/issues/new', '_blank') }
                ],
                error
            );
            document.body.appendChild(errorScreen);
        }
        
        // Toggle UI Mode (for debugging)
        function toggleUI() {
            window.webAutomationConfig.useEnhancedUI = !window.webAutomationConfig.useEnhancedUI;
            location.reload();
        }

        // Load script using traditional method (compatible with VS Code webviews) - Enhanced version
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if script is already loaded
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    console.log(`✅ Script already loaded: ${src}`);
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.type = 'text/javascript';
                script.async = true; // Ensure async loading
                
                // Add timeout for script loading
                const timeout = setTimeout(() => {
                    script.onload = null;
                    script.onerror = null;
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error(`Script loading timeout: ${src}`));
                }, 15000); // 15 second timeout
                
                script.onload = () => {
                    clearTimeout(timeout);
                    console.log(`✅ Script loaded: ${src}`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    clearTimeout(timeout);
                    console.error(`❌ Failed to load script: ${src}`, error);
                    reject(new Error(`Failed to load script: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // Create standardized error screen (Legacy compatibility function)
        function createErrorScreen(title, message, actions = [], error = null) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'error-screen';
            
            let errorDetails = '';
            if (error) {
                errorDetails = `
                    <details style="margin: 1rem 0; text-align: left;">
                        <summary>Technical Details</summary>
                        <pre style="background: var(--vscode-textCodeBlock-background, #2d2d30); padding: 1rem; border-radius: 4px; overflow: auto; max-height: 200px; font-size: 12px; white-space: pre-wrap;">${error.message}\n${error.stack || ''}</pre>
                    </details>
                `;
            }
            
            const actionButtons = actions.map(action => 
                `<button onclick="(${action.action.toString()})()" style="background: var(--vscode-button-background, #0e639c); color: var(--vscode-button-foreground, #ffffff); border: none; padding: 8px 16px; margin: 0 8px; border-radius: 2px; cursor: pointer; font-size: 14px;">${action.text}</button>`
            ).join('');
            
            errorContainer.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--vscode-editor-background, #1e1e1e); color: var(--vscode-foreground, #cccccc); display: flex; align-items: center; justify-content: center; z-index: 10000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="max-width: 600px; padding: 2rem; text-align: center;">
                        <h1 style="color: var(--vscode-errorForeground, #f14c4c); font-size: 24px; margin-bottom: 16px;">⚠️ ${title}</h1>
                        <p style="font-size: 16px; line-height: 1.5; margin-bottom: 24px;">${message}</p>
                        ${errorDetails}
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap;">
                            ${actionButtons}
                        </div>
                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--vscode-widget-border, #454545); color: var(--vscode-descriptionForeground, #9d9d9d); font-size: 12px;">
                            <p>VS Code Web Automation Tunnel</p>
                            <p>If this problem persists, please check the browser console (F12) for additional information.</p>
                        </div>
                    </div>
                </div>
            `;
            
            return errorContainer;
        }
        
        // Enhanced Performance Monitoring
        function initializePerformanceMonitoring() {
            // Monitor Core Web Vitals if available
            if (typeof PerformanceObserver !== 'undefined') {
                try {
                    const observer = new PerformanceObserver((list) => {
                        for (const entry of list.getEntries()) {
                            console.log(`Performance metric: ${entry.name} = ${entry.value}`);
                            
                            // Log critical metrics
                            if (entry.name === 'first-contentful-paint') {
                                console.log(`🎨 First Contentful Paint: ${entry.value}ms`);
                            } else if (entry.name === 'largest-contentful-paint') {
                                console.log(`🖼️ Largest Contentful Paint: ${entry.value}ms`);
                            }
                        }
                    });
                    
                    observer.observe({ entryTypes: ['paint', 'largest-contentful-paint', 'first-input', 'layout-shift'] });
                } catch (error) {
                    console.warn('Performance monitoring setup failed:', error);
                }
            }
        }

        // Remove no-js class when JavaScript is available
        document.documentElement.classList.remove('no-js');
        document.documentElement.classList.add('js');
        
        // Initialize performance monitoring early
        initializePerformanceMonitoring();
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', initializeUI);
        
        // Set up toggle UI button if it exists
        const toggleUIButton = document.getElementById('toggleUIButton');
        if (toggleUIButton) {
            toggleUIButton.addEventListener('click', toggleUI);
        }

        // Enhanced message handling for VS Code webview
        if (window.webAutomationConfig.isVSCodeWebview) {
            window.addEventListener('message', event => {
                const message = event.data;
                
                // Forward messages to active UI
                if (window.webAutomationConfig.useEnhancedUI && window.enhancedApp) {
                    if (typeof window.enhancedApp.handleMessage === 'function') {
                        window.enhancedApp.handleMessage(message);
                    }
                } else if (window.basicApp) {
                    if (typeof window.basicApp.handleMessage === 'function') {
                        window.basicApp.handleMessage(message);
                    }
                }
            });
        }
        
        // Global error handling with enhanced reporting
        window.addEventListener('error', (event) => {
            console.error('Global error caught:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            
            // If no UI has been loaded yet and this is a critical error, show fallback
            if (!window.enhancedApp && !window.basicApp && event.error) {
                const criticalErrors = ['Script error', 'NetworkError', 'TypeError: Failed to fetch'];
                if (criticalErrors.some(errType => event.message.includes(errType))) {
                    showFinalErrorScreen(event.error);
                }
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            
            // Log rejection details
            if (event.reason instanceof Error) {
                console.error('Rejection stack:', event.reason.stack);
            }
        });
        
        // Log initialization start
        console.log('🚀 VS Code Web Automation Tunnel initializing...');
        console.log('📋 Configuration:', window.webAutomationConfig);
        
        // Performance mark for initialization start
        if (performance.mark) {
            performance.mark('ui-initialization-start');
        }
    </script>
    
    <!-- Progressive Enhancement Detection System -->
    <script src="./js/utils/ProgressiveEnhancement.js"></script>
    <script src="./js/utils/LoadingStrategyEngine.js"></script>
    <script src="./js/services/PerformanceMonitoringService.js"></script>
    <script src="./js/progressive-enhancement-init.js"></script>
</body>
</html>