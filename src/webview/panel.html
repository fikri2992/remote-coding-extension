<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline'; connect-src ws: wss:;">
    <title>Web Automation Tunnel</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            font-weight: var(--vscode-font-weight);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 16px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            padding: 16px;
            background-color: var(--vscode-panel-background);
        }
        .title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--vscode-foreground);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            color: var(--vscode-foreground);
        }
        .description {
            font-size: 13px;
            color: var(--vscode-descriptionForeground);
            margin: 0 0 16px 0;
            line-height: 1.4;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.running {
            background-color: var(--vscode-testing-iconPassed);
        }

        .status-dot.stopped {
            background-color: var(--vscode-testing-iconFailed);
        }

        .status-dot.loading {
            background-color: var(--vscode-testing-iconQueued);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-dot.error {
            background-color: var(--vscode-errorForeground);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 13px;
            font-weight: 500;
        }

        .server-info {
            background-color: var(--vscode-textCodeBlock-background);
            border: 1px solid var(--vscode-textBlockQuote-border);
            border-radius: 3px;
            padding: 12px;
            margin: 12px 0;
            font-family: var(--vscode-editor-font-family);
            font-size: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: var(--vscode-descriptionForeground);
            font-weight: 500;
        }

        .info-value {
            color: var(--vscode-foreground);
            font-family: monospace;
        }
        .action-button {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: 1px solid var(--vscode-button-border, transparent);
            border-radius: 2px;
            padding: 8px 16px;
            font-size: 13px;
            font-family: var(--vscode-font-family);
            cursor: pointer;
            outline: none;
            transition: background-color 0.1s ease;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-button:hover:not(:disabled) {
            background-color: var(--vscode-button-hoverBackground);
        }

        .action-button:active:not(:disabled) {
            background-color: var(--vscode-button-background);
            transform: translateY(1px);
        }

        .action-button:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: 2px;
        }

        .action-button:disabled {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .secondary-button {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .secondary-button:hover:not(:disabled) {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }

        .error-message {
            background-color: var(--vscode-inputValidation-errorBackground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            color: var(--vscode-errorForeground);
            padding: 8px 12px;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 8px;
        }

        .clients-list {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 3px;
            background-color: var(--vscode-editor-background);
        }

        .client-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--vscode-panel-border);
            font-size: 12px;
        }

        .client-item:last-child {
            border-bottom: none;
        }

        .client-id {
            font-family: monospace;
            color: var(--vscode-textLink-foreground);
        }

        .client-time {
            color: var(--vscode-descriptionForeground);
            font-size: 11px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3 class="title">Web Automation Tunnel</h3>
        <p class="description">Control and monitor the web automation server for remote VS Code access.</p>
        
        <!-- Server Control Section -->
        <div class="section">
            <div class="section-title">Server Control</div>
            
            <div class="status-indicator">
                <div id="statusDot" class="status-dot stopped"></div>
                <span id="statusText" class="status-text">Server Stopped</span>
            </div>

            <div class="button-group">
                <button id="startServerBtn" class="action-button">
                    <span>‚ñ∂</span> Start Server
                </button>
                <button id="stopServerBtn" class="action-button secondary-button" disabled>
                    <span>‚èπ</span> Stop Server
                </button>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>
        </div>

        <!-- Server Information Section -->
        <div id="serverInfoSection" class="section hidden">
            <div class="section-title">Server Information</div>
            
            <div class="server-info">
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span id="serverStatus" class="info-value">Stopped</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Web Interface:</span>
                    <span id="webInterfaceUrl" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Public URL:</span>
                    <span id="publicUrl" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">HTTP Port:</span>
                    <span id="httpPort" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">WebSocket Port:</span>
                    <span id="websocketPort" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Uptime:</span>
                    <span id="uptime" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Connected Clients:</span>
                    <span id="clientCount" class="info-value">0</span>
                </div>
            </div>
        </div>

        <!-- Connected Clients Section -->
        <div id="clientsSection" class="section hidden">
            <div class="section-title">Connected Clients</div>
            <div id="clientsList" class="clients-list">
                <div class="client-item">No clients connected</div>
            </div>
        </div>

        <!-- Web Interface Section -->
        <div class="section">
            <div class="section-title">Web Interface</div>
            <p class="description">Access the full Vue.js interface in your browser for advanced features.</p>
            <div class="button-group">
                <button id="openWebInterfaceBtn" class="action-button">
                    <span>üåê</span> Open Web Interface
                </button>
                <button id="executeActionBtn" class="action-button secondary-button">
                    Execute Action
                </button>
            </div>
        </div>
    </div>

    <script>
        // Get reference to VSCode API
        const vscode = acquireVsCodeApi();
        
        // Get UI elements
        const startServerBtn = document.getElementById('startServerBtn');
        const stopServerBtn = document.getElementById('stopServerBtn');
        const executeButton = document.getElementById('executeActionBtn');
        const openWebInterfaceBtn = document.getElementById('openWebInterfaceBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const errorMessage = document.getElementById('errorMessage');
        const serverInfoSection = document.getElementById('serverInfoSection');
        const clientsSection = document.getElementById('clientsSection');
        
        // Server info elements
        const serverStatus = document.getElementById('serverStatus');
        const webInterfaceUrl = document.getElementById('webInterfaceUrl');
        const publicUrl = document.getElementById('publicUrl');
        const httpPort = document.getElementById('httpPort');
        const websocketPort = document.getElementById('websocketPort');
        const uptime = document.getElementById('uptime');
        const clientCount = document.getElementById('clientCount');
        const clientsList = document.getElementById('clientsList');

        // Current server state
        let currentServerState = {
            isRunning: false,
            isLoading: false
        };

        // Add click handlers for server control buttons
        startServerBtn.addEventListener('click', function() {
            if (currentServerState.isLoading) return;
            
            setLoadingState(true, 'Starting server...');
            vscode.postMessage({
                command: 'startServer'
            });
        });

        stopServerBtn.addEventListener('click', function() {
            if (currentServerState.isLoading) return;
            
            setLoadingState(true, 'Stopping server...');
            vscode.postMessage({
                command: 'stopServer'
            });
        });

        // Open web interface button
        openWebInterfaceBtn.addEventListener('click', function() {
            vscode.postMessage({
                command: 'openWebInterface'
            });
        });

        // Legacy execute action button
        executeButton.addEventListener('click', function() {
            executeButton.disabled = true;
            executeButton.textContent = 'Executing...';
            
            vscode.postMessage({
                command: 'executeAction',
                data: {
                    timestamp: new Date().toISOString(),
                    source: 'webview-button'
                }
            });
            
            setTimeout(() => {
                executeButton.disabled = false;
                executeButton.textContent = 'Execute Action';
            }, 1000);
        });
        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'serverStatusUpdate':
                    updateServerStatus(message.data.status, message.data.clients);
                    break;
                case 'statusUpdate':
                    handleStatusUpdate(message.data);
                    break;
                default:
                    console.log('Unknown message from extension:', message);
                    break;
            }
        });

        // Update server status display
        function updateServerStatus(status, clients) {
            currentServerState.isRunning = status.isRunning;
            currentServerState.isLoading = false;

            // Update status indicator
            statusDot.className = 'status-dot ' + (status.isRunning ? 'running' : 'stopped');
            statusText.textContent = status.isRunning ? 'Server Running' : 'Server Stopped';

            // Update button states
            startServerBtn.disabled = status.isRunning;
            stopServerBtn.disabled = !status.isRunning;
            startServerBtn.innerHTML = '<span>‚ñ∂</span> Start Server';
            stopServerBtn.innerHTML = '<span>‚èπ</span> Stop Server';

            // Update server information
            if (status.isRunning) {
                serverInfoSection.classList.remove('hidden');
                serverStatus.textContent = 'Running';
                webInterfaceUrl.textContent = status.webInterfaceUrl || 'http://localhost:3000';
                publicUrl.textContent = status.publicUrl || 'Setting up tunnel...';
                httpPort.textContent = status.httpPort || '-';
                websocketPort.textContent = status.websocketPort || '-';
                uptime.textContent = formatUptime(status.uptime);
                clientCount.textContent = status.connectedClients || 0;

                // Show clients section if there are connected clients
                if (status.connectedClients > 0) {
                    clientsSection.classList.remove('hidden');
                    updateClientsList(clients);
                } else {
                    clientsSection.classList.add('hidden');
                }
            } else {
                serverInfoSection.classList.add('hidden');
                clientsSection.classList.add('hidden');
            }

            // Handle errors
            if (status.lastError) {
                showError(status.lastError);
            } else {
                hideError();
            }
        }

        // Handle status updates (loading states, errors)
        function handleStatusUpdate(update) {
            switch (update.type) {
                case 'serverStarting':
                    setLoadingState(true, 'Starting server...');
                    break;
                case 'serverStopping':
                    setLoadingState(true, 'Stopping server...');
                    break;
                case 'serverError':
                    setLoadingState(false);
                    showError(update.error);
                    break;
            }
        }

        // Set loading state for buttons
        function setLoadingState(isLoading, message = '') {
            currentServerState.isLoading = isLoading;
            
            if (isLoading) {
                statusDot.className = 'status-dot loading';
                statusText.textContent = message;
                startServerBtn.disabled = true;
                stopServerBtn.disabled = true;
                startServerBtn.innerHTML = '<span>‚è≥</span> ' + message;
            }
        }

        // Update clients list
        function updateClientsList(clients) {
            if (!clients || clients.length === 0) {
                clientsList.innerHTML = '<div class="client-item">No clients connected</div>';
                return;
            }

            const clientsHtml = clients.map(client => `
                <div class="client-item">
                    <div class="client-id">${client.id}</div>
                    <div class="client-time">Connected: ${formatTime(client.connectedAt)}</div>
                </div>
            `).join('');

            clientsList.innerHTML = clientsHtml;
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Hide error message
        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // Format uptime in human readable format
        function formatUptime(milliseconds) {
            if (!milliseconds) return '-';
            
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Format time for display
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString();
        }

        // Handle keyboard events for accessibility
        [startServerBtn, stopServerBtn, executeButton, openWebInterfaceBtn].forEach(button => {
            button.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    button.click();
                }
            });
        });

        // Request initial server status
        vscode.postMessage({
            command: 'getServerStatus'
        });
        
        // Log that webview is ready
        console.log('Web Automation Tunnel webview loaded and ready');
    </script>
</body>
</html>